<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Human Filter ‚Äî Decode Influence. Decide Freely.</title>
    <meta name="description" content="Paste any message and reveal the hidden persuasion tactics, cognitive biases, and manipulation using Cialdini, Kahneman, 48 Laws of Power, and Dark Triad frameworks.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
:root {
    --bg: #06080f;
    --bg2: #0c1220;
    --bg3: #131d30;
    --bg4: #1a2744;
    --white: #f0f2f5;
    --text: #8a96a8;
    --text2: #b8c5d6;
    --gold: #d4a03c;
    --orange: #f97316;
    --purple: #a855f7;
    --cyan: #06b6d4;
    --pink: #ec4899;
    --red: #ef4444;
    --green: #10b981;
    --yellow: #f59e0b;
    --scan: #00f0ff;
    --radius: 12px;
    --font: 'Inter', system-ui, sans-serif;
    --serif: 'Playfair Display', Georgia, serif;
    --mono: 'JetBrains Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; min-height: 100%; }
body { background: var(--bg); color: var(--white); font-family: var(--font); font-size: 14px; line-height: 1.6; overflow-x: hidden; }

/* === AMBIENT BACKGROUND === */
body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background: radial-gradient(ellipse at 20% 0%, rgba(0,240,255,0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(168,85,247,0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(249,115,22,0.02) 0%, transparent 40%);
}

/* === GRID OVERLAY === */
body::after {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: linear-gradient(rgba(0,240,255,0.015) 1px, transparent 1px),
                      linear-gradient(90deg, rgba(0,240,255,0.015) 1px, transparent 1px);
    background-size: 60px 60px;
    animation: gridPulse 8s ease-in-out infinite;
}
@keyframes gridPulse { 0%,100%{opacity:.4} 50%{opacity:.7} }

.content-wrapper { position: relative; z-index: 1; }

/* === HEADER === */
.header {
    background: linear-gradient(180deg, rgba(12,18,32,0.98), rgba(6,8,15,0.95));
    border-bottom: 1px solid rgba(0,240,255,0.08);
    padding: 20px 16px 16px;
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(20px);
    text-align: center;
}
.header.embed-hidden { padding: 12px 16px 8px; }
.header h1 {
    font-family: var(--serif); font-size: 28px; font-weight: 800;
    background: linear-gradient(135deg, var(--white) 0%, var(--scan) 50%, var(--white) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: shimmer 4s linear infinite;
    line-height: 1.2; margin-bottom: 4px;
}
@keyframes shimmer { to { background-position: -200% center; } }
.header .subtitle-tag {
    font-family: var(--mono); font-size: 11px; color: var(--text);
    letter-spacing: 2px; text-transform: lowercase; font-style: italic;
}
.header .subtitle-tag em { color: var(--orange); font-style: normal; }

/* === MODE TOGGLE === */
.mode-toggle {
    display: flex; gap: 4px; justify-content: center; margin: 12px auto 0;
    background: var(--bg2); border-radius: 8px; padding: 3px; max-width: 380px;
    border: 1px solid rgba(0,240,255,0.06);
}
.mode-btn {
    flex: 1; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer;
    font-family: var(--font); font-size: 11px; font-weight: 600;
    color: var(--text); background: transparent; transition: all 0.3s;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.mode-btn.active { background: rgba(0,240,255,0.1); color: var(--scan); box-shadow: 0 0 12px rgba(0,240,255,0.15); }
.mode-btn:hover:not(.active) { color: var(--text2); }

/* === CONTAINER === */
.container { max-width: 900px; margin: 0 auto; padding: 0 16px 80px; position: relative; z-index: 1; }

/* === PRESETS === */
.presets-section { margin: 20px 0 24px; }
.presets-label { font-size: 10px; color: var(--text); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.presets-label::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, rgba(0,240,255,0.15), transparent); }
.presets-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: none; }
.presets-container::-webkit-scrollbar { display: none; }
.preset-card {
    flex: 0 0 130px; padding: 12px; border: 1px solid rgba(0,240,255,0.08);
    background: rgba(12,18,32,0.8); border-radius: 10px; cursor: pointer;
    transition: all 0.3s; text-align: center; backdrop-filter: blur(10px);
}
.preset-card:hover { border-color: var(--scan); box-shadow: 0 0 20px rgba(0,240,255,0.1); transform: translateY(-2px); }
.preset-card.selected { border-color: var(--scan); background: rgba(0,240,255,0.08); box-shadow: 0 0 25px rgba(0,240,255,0.2); }
.preset-emoji { font-size: 24px; margin-bottom: 6px; }
.preset-label { font-size: 11px; font-weight: 600; color: var(--white); }

/* === INPUT AREA === */
.input-section { margin-bottom: 20px; }
.input-wrapper {
    position: relative; border: 1px solid rgba(0,240,255,0.1);
    border-radius: var(--radius); background: rgba(12,18,32,0.6);
    overflow: hidden; backdrop-filter: blur(10px);
    transition: border-color 0.3s;
}
.input-wrapper:focus-within { border-color: rgba(0,240,255,0.3); box-shadow: 0 0 30px rgba(0,240,255,0.08); }
.input-wrapper textarea {
    width: 100%; min-height: 120px; padding: 16px; background: transparent;
    color: var(--white); border: none; font-family: var(--font); font-size: 14px;
    resize: vertical; outline: none; max-height: 300px;
}
.input-wrapper textarea::placeholder { color: var(--text); }
.input-actions {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px; border-top: 1px solid rgba(0,240,255,0.05);
}
.char-count { font-family: var(--mono); font-size: 11px; color: var(--text); }
.analyze-btn {
    padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer;
    font-family: var(--font); font-size: 13px; font-weight: 700;
    background: linear-gradient(135deg, var(--scan), rgba(0,200,255,0.8));
    color: var(--bg); transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
    position: relative; overflow: hidden;
}
.analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,240,255,0.3); }
.analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.analyze-btn::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
}
.analyze-btn:hover::after { animation: btnShine 0.6s ease; }
@keyframes btnShine { to { transform: translateX(100%); } }

/* === X-RAY SCANNER ANIMATION === */
.scanner-overlay {
    display: none; position: relative; margin: 20px 0;
    background: var(--bg2); border: 1px solid rgba(0,240,255,0.1);
    border-radius: var(--radius); overflow: hidden; padding: 20px;
    font-family: var(--mono); font-size: 13px; line-height: 1.8;
    color: var(--text2);
}
.scanner-overlay.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.scan-line {
    position: absolute; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--scan), transparent);
    box-shadow: 0 0 20px var(--scan), 0 0 60px rgba(0,240,255,0.3);
    animation: scanDown 3s ease-in-out infinite;
    z-index: 10;
}
@keyframes scanDown { 0%{top:0;opacity:0} 5%{opacity:1} 95%{opacity:1} 100%{top:100%;opacity:0} }

.scan-word { display: inline; transition: all 0.3s; }
.scan-word.scanned { color: var(--white); }
.scan-word.flagged-high { color: var(--red); text-shadow: 0 0 8px rgba(239,68,68,0.5); background: rgba(239,68,68,0.08); padding: 0 2px; border-radius: 3px; }
.scan-word.flagged-med { color: var(--orange); text-shadow: 0 0 6px rgba(249,115,22,0.4); }
.scan-word.flagged-low { color: var(--yellow); }
.scan-word.clean { color: var(--green); opacity: 0.7; }

.scanner-status {
    display: flex; flex-direction: column; gap: 8px; margin-top: 16px;
    padding-top: 16px; border-top: 1px solid rgba(0,240,255,0.06);
}
.scan-step {
    display: flex; align-items: center; gap: 10px;
    font-size: 11px; color: var(--text); transition: all 0.4s;
}
.scan-step.active { color: var(--scan); }
.scan-step.done { color: var(--green); }
.scan-step .dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--text); transition: all 0.3s;
}
.scan-step.active .dot { background: var(--scan); box-shadow: 0 0 10px var(--scan); animation: pulse 1s infinite; }
.scan-step.done .dot { background: var(--green); }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.4)} }

/* === RESULTS TABS === */
.results-section { display: none; margin-top: 24px; }
.results-section.active { display: block; animation: fadeIn 0.4s ease; }

.result-tabs {
    display: flex; gap: 2px; background: var(--bg2); border-radius: 10px; padding: 3px;
    margin-bottom: 20px; border: 1px solid rgba(0,240,255,0.06);
    overflow-x: auto; scrollbar-width: none;
}
.result-tabs::-webkit-scrollbar { display: none; }
.result-tab {
    flex: 1; min-width: max-content; padding: 10px 16px; border: none; border-radius: 8px;
    cursor: pointer; font-family: var(--font); font-size: 11px; font-weight: 600;
    color: var(--text); background: transparent; transition: all 0.3s;
    text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
}
.result-tab.active { background: rgba(0,240,255,0.1); color: var(--scan); }
.result-tab:hover:not(.active) { color: var(--text2); background: rgba(255,255,255,0.02); }

.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeIn 0.3s ease; }

/* === VERDICT CARD === */
.verdict-card {
    background: linear-gradient(135deg, var(--bg2), var(--bg3));
    border: 1px solid rgba(0,240,255,0.1); border-radius: var(--radius);
    padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden;
}
.verdict-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--scan), var(--orange), var(--purple));
}
.verdict-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
.verdict-score {
    width: 72px; height: 72px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-family: var(--mono); font-size: 26px; font-weight: 700;
    border: 3px solid; position: relative;
}
.verdict-score::after {
    content: ''; position: absolute; inset: -6px; border-radius: 50%;
    border: 1px solid; opacity: 0.3; animation: ringPulse 2s infinite;
}
@keyframes ringPulse { 0%,100%{transform:scale(1);opacity:.3} 50%{transform:scale(1.08);opacity:.1} }
.verdict-info { flex: 1; }
.verdict-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
.verdict-text { font-size: 14px; color: var(--text2); line-height: 1.5; }
.verdict-context {
    display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 10px;
    font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    background: rgba(0,240,255,0.08); color: var(--scan); margin-top: 8px;
    border: 1px solid rgba(0,240,255,0.15);
}

/* === FRAMEWORK BADGES === */
.framework-grid { display: flex; gap: 8px; flex-wrap: wrap; margin: 16px 0; }
.fw-badge {
    display: flex; align-items: center; gap: 6px; padding: 6px 12px;
    border-radius: 20px; font-size: 10px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    border: 1px solid; opacity: 0.7; transition: all 0.3s;
}
.fw-badge.active { opacity: 1; }
.fw-badge.persuasion { color: var(--orange); border-color: rgba(249,115,22,0.3); background: rgba(249,115,22,0.06); }
.fw-badge.bias { color: var(--purple); border-color: rgba(168,85,247,0.3); background: rgba(168,85,247,0.06); }
.fw-badge.logic { color: var(--cyan); border-color: rgba(6,182,212,0.3); background: rgba(6,182,212,0.06); }
.fw-badge.emotional { color: var(--pink); border-color: rgba(236,72,153,0.3); background: rgba(236,72,153,0.06); }
.fw-badge.power { color: var(--red); border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.06); }
.fw-badge.kahneman { color: #818cf8; border-color: rgba(129,140,248,0.3); background: rgba(129,140,248,0.06); }
.fw-badge.laws { color: var(--gold); border-color: rgba(212,160,60,0.3); background: rgba(212,160,60,0.06); }
.fw-badge.dark-triad { color: #94a3b8; border-color: rgba(148,163,184,0.3); background: rgba(148,163,184,0.06); }

/* === FINDINGS LIST === */
.finding-card {
    background: var(--bg2); border: 1px solid rgba(255,255,255,0.04);
    border-radius: var(--radius); padding: 20px; margin-bottom: 12px;
    transition: all 0.3s; border-left: 3px solid;
}
.finding-card:hover { border-color: rgba(0,240,255,0.15); background: var(--bg3); }
.finding-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.finding-engine { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; padding: 3px 8px; border-radius: 4px; }
.finding-name { font-size: 14px; font-weight: 600; color: var(--white); }
.finding-severity { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: auto; text-transform: uppercase; }
.sev-high { background: rgba(239,68,68,0.15); color: var(--red); }
.sev-medium { background: rgba(249,115,22,0.15); color: var(--orange); }
.sev-low { background: rgba(245,158,11,0.15); color: var(--yellow); }
.finding-quote { font-family: var(--mono); font-size: 12px; color: var(--text); padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; margin: 8px 0; border-left: 2px solid var(--text); }
.finding-decoded { font-size: 13px; color: var(--text2); margin: 8px 0; }
.finding-legal { font-size: 12px; color: var(--text); padding: 8px 12px; background: rgba(212,160,60,0.05); border-radius: 6px; border-left: 2px solid var(--gold); margin: 8px 0; font-family: var(--font); }
.finding-ask { font-size: 12px; color: var(--scan); font-style: italic; margin: 8px 0; }
.counter-moves { margin-top: 10px; padding: 12px; background: rgba(16,185,129,0.04); border-radius: 8px; border: 1px solid rgba(16,185,129,0.1); }
.counter-move { font-size: 12px; color: var(--text2); margin: 6px 0; }
.counter-move strong { color: var(--green); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

/* === COMPARISON VIEW === */
.comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: rgba(0,240,255,0.06); border-radius: var(--radius); overflow: hidden; }
@media(max-width:640px) { .comparison-grid { grid-template-columns: 1fr; } }
.comparison-col-header {
    padding: 12px 16px; font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
}
.comp-original-header { background: rgba(239,68,68,0.08); color: var(--red); }
.comp-decoded-header { background: rgba(16,185,129,0.08); color: var(--green); }
.comp-row { display: contents; }
.comp-cell { padding: 12px 16px; font-size: 13px; line-height: 1.6; background: var(--bg2); border-bottom: 1px solid rgba(255,255,255,0.02); }
.comp-cell.original { color: var(--text); }
.comp-cell.decoded { color: var(--text2); }
.comp-severity-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }

/* === PSYCHOLOGICAL PROFILE === */
.profile-card { background: var(--bg2); border: 1px solid rgba(168,85,247,0.15); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.profile-section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.profile-text { font-size: 13px; color: var(--text2); line-height: 1.7; }
.system-badge { font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 20px; display: inline-block; margin: 4px 4px 4px 0; }
.system1 { background: rgba(239,68,68,0.1); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }
.system2 { background: rgba(6,182,212,0.1); color: var(--cyan); border: 1px solid rgba(6,182,212,0.2); }
.law-card { padding: 10px 14px; background: rgba(212,160,60,0.04); border-radius: 8px; border-left: 2px solid var(--gold); margin: 8px 0; }
.law-num { font-family: var(--mono); font-size: 11px; color: var(--gold); font-weight: 700; }
.law-name { font-size: 13px; color: var(--white); font-weight: 600; }
.law-how { font-size: 12px; color: var(--text); margin-top: 4px; }
.dark-triad-meter { display: flex; gap: 12px; margin: 12px 0; }
.dt-item { flex: 1; text-align: center; }
.dt-label { font-size: 10px; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.dt-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.dt-fill { height: 100%; border-radius: 2px; transition: width 1s ease; }
.dt-value { font-family: var(--mono); font-size: 12px; margin-top: 4px; font-weight: 600; }
.neuro-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; margin: 3px; border: 1px solid; }
.neuro-dopamine { color: #fbbf24; border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.06); }
.neuro-cortisol { color: var(--red); border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.06); }
.neuro-oxytocin { color: var(--pink); border-color: rgba(236,72,153,0.3); background: rgba(236,72,153,0.06); }
.neuro-serotonin { color: var(--green); border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.06); }

/* === COACH MODE === */
.coach-card { background: linear-gradient(135deg, var(--bg2), rgba(16,185,129,0.04)); border: 1px solid rgba(16,185,129,0.15); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.coach-response { font-size: 14px; color: var(--white); line-height: 1.7; padding: 16px; background: rgba(16,185,129,0.06); border-radius: 8px; border-left: 3px solid var(--green); margin: 12px 0; }
.copy-response-btn { padding: 8px 16px; border: 1px solid rgba(16,185,129,0.3); border-radius: 6px; background: transparent; color: var(--green); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s; }
.copy-response-btn:hover { background: rgba(16,185,129,0.1); }

/* === COGNITIVE DISTORTIONS === */
.distortion-card { background: var(--bg2); border: 1px solid rgba(236,72,153,0.1); border-radius: 8px; padding: 14px; margin: 8px 0; }
.distortion-name { font-size: 12px; font-weight: 700; color: var(--pink); margin-bottom: 4px; }
.distortion-quote { font-family: var(--mono); font-size: 11px; color: var(--text); margin: 6px 0; }
.distortion-reframe { font-size: 12px; color: var(--green); }

/* === LEGAL NOTES === */
.legal-section { margin-top: 16px; }
.legal-note {
    font-size: 12px; color: var(--text2); padding: 10px 14px;
    background: rgba(212,160,60,0.04); border-radius: 8px;
    border-left: 2px solid var(--gold); margin: 8px 0;
    font-family: var(--font); line-height: 1.6;
}

/* === WATERMARK === */
.watermark { text-align: center; margin-top: 24px; padding: 16px; opacity: 0.5; }
.watermark span { font-size: 10px; color: var(--text); letter-spacing: 1px; }
.hf-badge { font-family: var(--mono); font-size: 11px; font-weight: 700; color: var(--scan); letter-spacing: 2px; margin: 4px 0; }

/* === TOAST === */
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg3); color: var(--white); padding: 12px 20px; border-radius: 8px; font-size: 13px; z-index: 9999; transition: transform 0.3s; border: 1px solid rgba(0,240,255,0.15); }
.toast.active { transform: translateX(-50%) translateY(0); }
.toast.error { border-color: rgba(239,68,68,0.3); }

/* === FOOTER === */
.footer { text-align: center; padding: 24px 16px; font-size: 11px; color: var(--text); border-top: 1px solid rgba(0,240,255,0.05); margin-top: 32px; }
.footer.embed-hidden { display: none; }
.footer a { color: var(--scan); text-decoration: none; }
.footer a:hover { text-decoration: underline; }

/* === RESPONSIVE === */
@media(max-width:640px) {
    .header h1 { font-size: 22px; }
    .mode-toggle { max-width: 100%; }
    .verdict-header { flex-direction: column; text-align: center; }
    .dark-triad-meter { flex-direction: column; }
}

/* === PWA MODAL === */
.pwa-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; justify-content: center; align-items: center; padding: 20px; }
.pwa-modal.active { display: flex; }
.pwa-modal-content { background: var(--bg3); border-radius: 16px; padding: 28px; max-width: 440px; width: 100%; border: 1px solid rgba(0,240,255,0.1); }
.pwa-header { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.pwa-step { background: var(--bg2); border-left: 3px solid var(--scan); padding: 12px; border-radius: 6px; margin: 10px 0; }
.pwa-step-title { font-size: 11px; font-weight: 600; color: var(--scan); margin-bottom: 4px; }
.pwa-step-content { font-size: 12px; color: var(--text2); }
.pwa-close { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; background: var(--scan); color: var(--bg); margin-top: 16px; }
</style>
</head>
<body>
<div class="content-wrapper">

<!-- HEADER -->
<div class="header" id="header">
    <h1>The Human Filter</h1>
    <div class="subtitle-tag"><em>since bullshit detector was taken</em></div>
    <div class="mode-toggle">
        <button class="mode-btn active" data-mode="defense" onclick="setMode('defense')">üõ° Defense</button>
        <button class="mode-btn" data-mode="mirror" onclick="setMode('mirror')">ü™û Mirror</button>
        <button class="mode-btn" data-mode="coach" onclick="setMode('coach')">üß† Coach</button>
    </div>
</div>

<!-- MAIN -->
<div class="container">

    <!-- PRESETS -->
    <div class="presets-section">
        <div class="presets-label">Quick scan examples</div>
        <div class="presets-container" id="presetsContainer"></div>
    </div>

    <!-- INPUT -->
    <div class="input-section">
        <div class="input-wrapper">
            <textarea id="messageInput" placeholder="Paste any message ‚Äî an email, a text, a contract clause, a sales pitch, a dating message..."></textarea>
            <div class="input-actions">
                <span class="char-count" id="charCount">0 chars</span>
                <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()">‚ö° Scan Message</button>
            </div>
        </div>
    </div>

    <!-- X-RAY SCANNER -->
    <div class="scanner-overlay" id="scannerOverlay">
        <div class="scan-line"></div>
        <div id="scanText"></div>
        <div class="scanner-status" id="scannerStatus">
            <div class="scan-step" data-step="cialdini"><div class="dot"></div><span>Cialdini's 6 Principles of Influence</span></div>
            <div class="scan-step" data-step="kahneman"><div class="dot"></div><span>Kahneman System 1/System 2 Analysis</span></div>
            <div class="scan-step" data-step="laws"><div class="dot"></div><span>48 Laws of Power Mapping</span></div>
            <div class="scan-step" data-step="dark"><div class="dot"></div><span>Dark Triad Pattern Detection</span></div>
            <div class="scan-step" data-step="neuro"><div class="dot"></div><span>Neurochemical Trigger Analysis</span></div>
            <div class="scan-step" data-step="legal"><div class="dot"></div><span>Legal Perspective Scan</span></div>
        </div>
    </div>

    <!-- RESULTS -->
    <div class="results-section" id="resultsSection">
        <div class="result-tabs">
            <button class="result-tab active" onclick="showTab('verdict')">‚ö° Verdict</button>
            <button class="result-tab" onclick="showTab('xray')">üîç X-Ray</button>
            <button class="result-tab" onclick="showTab('profile')">üß† Profile</button>
            <button class="result-tab" onclick="showTab('coach')">üí¨ Coach</button>
        </div>
        <div class="tab-panel active" id="tab-verdict"></div>
        <div class="tab-panel" id="tab-xray"></div>
        <div class="tab-panel" id="tab-profile"></div>
        <div class="tab-panel" id="tab-coach"></div>
    </div>

</div>

<!-- PWA MODAL -->
<div class="pwa-modal" id="pwaModal">
    <div class="pwa-modal-content">
        <div class="pwa-header">üì± Add to Home Screen</div>
        <div class="pwa-step"><div class="pwa-step-title">Step 1</div><div class="pwa-step-content">Tap the <strong>Share</strong> button (üì§) in Safari, or <strong>‚ãÆ</strong> menu in Chrome</div></div>
        <div class="pwa-step"><div class="pwa-step-title">Step 2</div><div class="pwa-step-content">Select <strong>"Add to Home Screen"</strong></div></div>
        <div class="pwa-step"><div class="pwa-step-title">Step 3</div><div class="pwa-step-content">Launch The Human Filter like a native app ‚Äî no browser needed</div></div>
        <button class="pwa-close" onclick="document.getElementById('pwaModal').classList.remove('active')">Got it</button>
    </div>
</div>

<!-- FOOTER -->
<div class="footer" id="footer">
    <div class="hf-badge">THE HUMAN FILTER</div>
    <div>Built by <a href="https://aakarshsharma.com" target="_blank">Aakarsh Sharma</a> ¬∑ <a href="https://aakarshsharma.com" target="_blank">Human Layer AI</a></div>
    <div style="margin-top:6px"><em>Law √ó Psychology √ó AI</em></div>
    <div style="margin-top:8px"><a href="#" onclick="document.getElementById('pwaModal').classList.add('active');return false;">üì± Add to Home Screen</a></div>
</div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===================================================
// THE HUMAN FILTER v7 ‚Äî COMPLETE ENGINE
// ===================================================

const PRESETS = {
    boss: { emoji: 'üëî', label: 'Toxic Boss', text: "I thought you'd have this done by now. I'm not angry, just disappointed. I've gone out of my way to give you opportunities others would kill for. Maybe this role just isn't the right fit?" },
    sales: { emoji: 'üõí', label: 'Sales Email', text: "Hey! I noticed you checked out our platform 3 times this week. Honestly, I wasn't going to reach out, but our CEO personally asked me to ‚Äî he thinks you'd be perfect for our pilot program. We only have 2 spots left and the price doubles next Monday." },
    dating: { emoji: 'üíî', label: 'Love Bombing', text: "I've never felt this way about anyone before. You're literally the only person who understands me. My ex was so toxic, but you're different. I know we just met last week, but I feel like I've known you forever. Can you skip your friend's birthday? I planned something special for us." },
    contract: { emoji: 'üìã', label: 'Contract', text: "This standard agreement grants us perpetual, irrevocable, worldwide rights to all work product. Non-compete applies for 24 months post-termination within any related field. Disputes resolved via binding arbitration in our jurisdiction. Sign by EOD to maintain your current rate." },
    crypto: { emoji: 'ü™ô', label: 'Crypto Scam', text: "URGENT: My algorithm just detected a 10x opportunity. I made $47,000 last month alone. Only sharing with my inner circle. The window closes in 4 hours. Send 0.5 ETH to this wallet and I'll 5x it by tomorrow. This is NOT financial advice but you'd be crazy to miss this." },
    parent: { emoji: 'üë®‚Äçüë©‚Äçüëß', label: 'Guilt Trip', text: "After everything I've sacrificed for you, this is how you repay me? I gave up my career so you could have a better life. Your cousin just bought her parents a house. I'm not saying you should do that, but it would be nice to know my sacrifices meant something." },
    linkedin: { emoji: 'üíº', label: 'LinkedIn DM', text: "Really impressed by your profile! I'm building an AI startup that's going to revolutionize the industry. We just closed a round with top VCs (can't name them yet, NDA). I'm handpicking my founding team and I think you'd be perfect. Can you jump on a quick call today? No salary yet but the equity will be worth millions." },
    news: { emoji: 'üì∞', label: 'Clickbait', text: "BREAKING: Scientists discover shocking truth about common food that millions eat daily. What the industry doesn't want you to know could save your life. Exposed: the cover-up that's been hidden for decades. Click now before this gets taken down." }
};

let currentMode = 'defense';
let lastAnalysis = null;

function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    const ta = document.getElementById('messageInput');
    if (mode === 'defense') ta.placeholder = "Paste any message ‚Äî an email, a text, a contract clause, a sales pitch, a dating message...";
    else if (mode === 'mirror') ta.placeholder = "Paste YOUR OWN message to check for unconscious manipulation patterns...";
    else ta.placeholder = "Paste the message you received. I'll decode it AND draft your strategic response...";
}

function getApiKey() { return localStorage.getItem('hf_api_key') || ''; }
function setApiKey(key) { localStorage.setItem('hf_api_key', key); }
function promptForApiKey() {
    const existing = getApiKey();
    const key = prompt('Enter your OpenAI API key to power The Human Filter.\nStored locally ‚Äî never sent anywhere except OpenAI.', existing);
    if (key && key.trim().startsWith('sk-')) { setApiKey(key.trim()); return key.trim(); }
    return null;
}

function toast(msg, isError) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast' + (isError ? ' error' : '');
    requestAnimationFrame(() => t.classList.add('active'));
    setTimeout(() => t.classList.remove('active'), 3500);
}

function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function isEmbedMode() { return new URLSearchParams(window.location.search).has('embed'); }

// Rate limiting
function getRateData() {
    const d = JSON.parse(localStorage.getItem('hf_rate') || '{"c":0,"d":null}');
    if (d.d !== new Date().toDateString()) return { c: 0, d: new Date().toDateString() };
    return d;
}
function bumpRate() { const d = getRateData(); d.c++; localStorage.setItem('hf_rate', JSON.stringify(d)); }
function isLimited() { return getRateData().c >= 30; }
function canAnalyze() { return Date.now() - parseInt(localStorage.getItem('hf_last') || '0') >= 10000; }

const MODE_PROMPTS = {
    defense: 'Analyze this message that was SENT TO the user. Identify manipulation tactics, influence patterns, and hidden agendas. Be the user\'s shield.',
    mirror: 'Analyze this message that the user WROTE THEMSELVES. Identify any unconscious manipulation, persuasion tactics, or cognitive biases in their own language. Be honest but constructive ‚Äî help them see their blind spots.',
    coach: 'Analyze this message that was SENT TO the user, AND provide a strategically crafted response. The response should be psychologically informed, assertive but not aggressive, and neutralize any manipulation detected.'
};

const SYSTEM_PROMPT = `You are The Human Filter v7 ‚Äî a multi-framework psychological analysis engine built by a legal professional (5 years litigation) and behavioral psychologist (93 books, 100+ expert interviews). You decode hidden influence in any communication.

ANALYSIS FRAMEWORKS ‚Äî Apply ALL that are relevant:

1. CIALDINI'S 6 PRINCIPLES: Reciprocity, Commitment/Consistency, Social Proof, Authority, Liking, Scarcity
2. KAHNEMAN SYSTEM 1/2: Is the message targeting fast emotional (System 1) or slow rational (System 2) thinking? Which cognitive biases are exploited?
3. 48 LAWS OF POWER (Robert Greene): Map tactics to specific laws. Examples: Law 3 (Conceal Intentions), Law 6 (Court Attention), Law 12 (Selective Honesty), Law 13 (Self-Interest Appeal), Law 15 (Crush Totally), Law 17 (Unpredictability), Law 27 (Create Cult), Law 33 (Discover Weakness), Law 40 (Despise Free Lunch)
4. DARK TRIAD DETECTION: Rate Machiavellianism (0-100), Narcissism (0-100), Psychopathy (0-100) based on language patterns
5. NEUROCHEMICAL TRIGGERS (Huberman-informed): What neurochemicals does this message try to trigger? Dopamine (reward/anticipation), Cortisol (stress/urgency), Oxytocin (trust/bonding), Serotonin (status/hierarchy)
6. COGNITIVE DISTORTIONS (Beck's CBT): all-or-nothing, overgeneralization, mental filter, catastrophizing, emotional reasoning, should statements, labeling, personalization
7. LEGAL PERSPECTIVE: Contract implications, liability exposure, evidence preservation needs, rights awareness

ANALYSIS ENGINES (always apply):
- PERSUASION: Cialdini principles, dark patterns, manipulation tactics
- COGNITIVE BIAS: anchoring, framing, availability, Dunning-Kruger, sunk cost, halo effect, bandwagon
- LOGICAL FALLACIES: false dilemma, ad hominem, circular reasoning, slippery slope, appeal to emotion
- EMOTIONAL MANIPULATION: guilt-tripping, love bombing, gaslighting, future faking, intermittent reinforcement
- POWER DYNAMICS: implicit threats, boundary violations, deadline coercion, information asymmetry

Return ONLY valid JSON (no markdown fences):
{
  "score": <0-100>,
  "context": "<dating|personal|business|legal|crypto|scam|harassment|money|job|general>",
  "verdict": "<One compelling sentence summarizing the overall pattern>",
  "mode_note": "<If mirror mode: constructive note about the user's own patterns. If coach mode: strategic overview of recommended approach>",
  "findings": [
    {
      "engine": "<PERSUASION|BIAS|LOGIC|EMOTIONAL|POWER>",
      "name": "<Tactic Name>",
      "severity": "<high|medium|low>",
      "quote": "<exact quote>",
      "decoded": "<plain language translation>",
      "legal": "<legal perspective>",
      "ask": "<question the reader should ask>",
      "cialdini": "<which Cialdini principle, if any>",
      "counter_moves": {
        "what_to_say": "<exact words>",
        "recognize_it": "<how to spot next time>",
        "protect_yourself": "<long-term strategy>"
      }
    }
  ],
  "xray": [
    {
      "original": "<original sentence>",
      "decoded": "<honest translation>",
      "severity": "<high|medium|low|clean>",
      "cognitive_bias_used": "<bias name>"
    }
  ],
  "kahneman": {
    "primary_system_targeted": <1 or 2>,
    "system1_triggers": ["<list of System 1 exploits>"],
    "system2_bypasses": ["<how they bypass rational thinking>"],
    "debiasing_strategy": "<how to activate System 2 against this>"
  },
  "laws_of_power": [
    {
      "law_number": <1-48>,
      "law_name": "<name>",
      "how_used": "<how this message employs the law>",
      "counter_law": "<which law to deploy in defense>"
    }
  ],
  "dark_triad": {
    "machiavellianism": <0-100>,
    "narcissism": <0-100>,
    "psychopathy": <0-100>,
    "summary": "<brief Dark Triad profile>"
  },
  "neurochemical_triggers": [
    { "chemical": "<dopamine|cortisol|oxytocin|serotonin>", "trigger": "<what triggers it>", "defense": "<how to resist>" }
  ],
  "cognitive_distortions": [
    { "distortion": "<name>", "quote": "<triggering quote>", "reframe": "<healthier alternative>" }
  ],
  "vibe": {
    "tone": "<emoji + description>",
    "red_flags": "<count and names>",
    "pattern": "<overall pattern name>"
  },
  "response": "<suggested strategic response>",
  "legal_notes": ["<at least 3 legal observations>"]
}

CRITICAL RULES:
- legal_notes MUST have 3+ items. NEVER empty.
- findings MUST have 3+ items. Be thorough.
- xray MUST have entries for each sentence.
- laws_of_power MUST have 1+ items.
- All arrays must be populated. Never return empty arrays.`;

async function analyzeMessage(text) {
    let apiKey = getApiKey();
    if (!apiKey) { apiKey = promptForApiKey(); if (!apiKey) throw new Error('API key required.'); }

    const modePrompt = MODE_PROMPTS[currentMode];

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
                { role: 'system', content: SYSTEM_PROMPT },
                { role: 'user', content: `${modePrompt}\n\nAnalyze this message:\n\n${text}` }
            ],
            temperature: 0.7,
            max_tokens: 4000
        })
    });
    if (!response.ok) throw new Error(`API Error: ${response.status}`);
    const data = await response.json();
    let content = data.choices[0].message.content.trim();
    if (content.startsWith('```')) content = content.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    const result = JSON.parse(jsonMatch ? jsonMatch[0] : content);

    // Ensure all required fields
    if (!result.findings || result.findings.length === 0) result.findings = [];
    if (!result.xray) result.xray = [];
    if (!result.legal_notes || result.legal_notes.length === 0) result.legal_notes = ["Document this communication as potential evidence.", "Consult legal counsel if uncertain about obligations.", "Know your rights before responding."];
    if (!result.kahneman) result.kahneman = { primary_system_targeted: 1, system1_triggers: [], system2_bypasses: [], debiasing_strategy: "Take 24 hours before responding." };
    if (!result.laws_of_power) result.laws_of_power = [];
    if (!result.dark_triad) result.dark_triad = { machiavellianism: 0, narcissism: 0, psychopathy: 0, summary: "Insufficient data" };
    if (!result.neurochemical_triggers) result.neurochemical_triggers = [];
    if (!result.cognitive_distortions) result.cognitive_distortions = [];
    if (!result.vibe) result.vibe = {};
    if (!result.score) result.score = Math.min(result.findings.reduce((s, f) => s + (f.severity === 'high' ? 15 : f.severity === 'medium' ? 8 : 3), 0), 100);

    return result;
}

// === X-RAY SCANNER ANIMATION ===
async function animateScanner(text) {
    const overlay = document.getElementById('scannerOverlay');
    const scanText = document.getElementById('scanText');
    overlay.classList.add('active');

    // Split text into words and wrap in spans
    const words = text.split(/(\s+)/);
    scanText.innerHTML = words.map((w, i) => w.trim() ? `<span class="scan-word" data-idx="${i}">${escapeHtml(w)}</span>` : w).join('');

    // Animate scan steps
    const steps = ['cialdini', 'kahneman', 'laws', 'dark', 'neuro', 'legal'];
    for (let i = 0; i < steps.length; i++) {
        const stepEl = document.querySelector(`.scan-step[data-step="${steps[i]}"]`);
        stepEl.classList.add('active');

        // Randomly flag some words during this step
        const wordEls = document.querySelectorAll('.scan-word:not(.scanned)');
        const flagCount = Math.floor(wordEls.length * 0.08);
        for (let j = 0; j < flagCount; j++) {
            const idx = Math.floor(Math.random() * wordEls.length);
            const severity = ['flagged-high', 'flagged-med', 'flagged-low', 'clean'][Math.floor(Math.random() * 4)];
            wordEls[idx].classList.add('scanned', severity);
        }

        await new Promise(r => setTimeout(r, 500));
        stepEl.classList.remove('active');
        stepEl.classList.add('done');
    }

    // Mark remaining words as scanned
    document.querySelectorAll('.scan-word:not(.scanned)').forEach(w => w.classList.add('scanned', 'clean'));
}

function hideScanner() {
    document.getElementById('scannerOverlay').classList.remove('active');
    document.querySelectorAll('.scan-step').forEach(s => { s.classList.remove('active', 'done'); });
}

// === RUN ANALYSIS ===
async function runAnalysis() {
    const text = document.getElementById('messageInput').value.trim();
    if (!text) { toast('Paste a message first.', true); return; }
    if (text.length < 10) { toast('Message too short for meaningful analysis.', true); return; }
    if (isLimited()) { toast('Daily limit reached (30/day). Try tomorrow.', true); return; }
    if (!canAnalyze()) { toast('Please wait a few seconds between scans.', true); return; }

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true; btn.textContent = '‚ö° Scanning...';
    document.getElementById('resultsSection').classList.remove('active');

    try {
        // Start scanner animation
        await animateScanner(text);

        // Run actual analysis
        const analysis = await analyzeMessage(text);
        lastAnalysis = analysis;
        bumpRate();
        localStorage.setItem('hf_last', Date.now().toString());

        // Hide scanner, show results
        hideScanner();
        renderResults(analysis);
        document.getElementById('resultsSection').classList.add('active');
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch (err) {
        hideScanner();
        toast(err.message, true);
        if (err.message.includes('401') || err.message.includes('403')) setTimeout(() => promptForApiKey(), 500);
    } finally {
        btn.disabled = false; btn.textContent = '‚ö° Scan Message';
    }
}

// === RENDERING ===
function getScoreColor(s) { return s >= 76 ? '#ef4444' : s >= 51 ? '#f97316' : s >= 26 ? '#f59e0b' : '#10b981'; }
function getScoreLabel(s) { return s >= 76 ? 'DANGER' : s >= 51 ? 'CAUTION' : s >= 26 ? 'MILD' : 'SAFE'; }

function renderResults(a) {
    renderVerdict(a);
    renderXRay(a);
    renderProfile(a);
    renderCoach(a);
    showTab('verdict');
}

function renderVerdict(a) {
    const color = getScoreColor(a.score);
    const label = getScoreLabel(a.score);
    const ctx = a.context ? a.context.toUpperCase() : 'GENERAL';

    let html = `<div class="verdict-card"><div class="verdict-header"><div class="verdict-score" style="color:${color};border-color:${color}">${Math.round(a.score)}</div><div class="verdict-info"><div class="verdict-label" style="color:${color}">${label}</div><div class="verdict-text">${escapeHtml(a.verdict || '')}</div><div class="verdict-context">${ctx}</div></div></div>`;

    // Framework badges
    const fws = [];
    if (a.findings.some(f => f.cialdini)) fws.push({ cls: 'persuasion', label: 'Cialdini' });
    if (a.kahneman) fws.push({ cls: 'kahneman', label: `System ${a.kahneman.primary_system_targeted || 1} Target` });
    if (a.laws_of_power && a.laws_of_power.length) fws.push({ cls: 'laws', label: `${a.laws_of_power.length} Laws Detected` });
    if (a.dark_triad) fws.push({ cls: 'dark-triad', label: 'Dark Triad' });
    if (a.neurochemical_triggers && a.neurochemical_triggers.length) fws.push({ cls: 'emotional', label: 'Neurochemical' });
    if (fws.length) {
        html += `<div class="framework-grid">${fws.map(f => `<div class="fw-badge active ${f.cls}">${f.label}</div>`).join('')}</div>`;
    }

    // Mode note
    if (a.mode_note) html += `<div style="font-size:13px;color:var(--text2);padding:12px;background:rgba(0,240,255,0.03);border-radius:8px;margin-top:12px;border-left:2px solid var(--scan)">${escapeHtml(a.mode_note)}</div>`;

    // Findings
    html += `<div style="margin-top:20px">`;
    (a.findings || []).forEach(f => {
        const engineColors = { PERSUASION: 'var(--orange)', BIAS: 'var(--purple)', LOGIC: 'var(--cyan)', EMOTIONAL: 'var(--pink)', POWER: 'var(--red)' };
        const ec = engineColors[f.engine] || 'var(--text)';
        const sevCls = f.severity === 'high' ? 'sev-high' : f.severity === 'medium' ? 'sev-medium' : 'sev-low';

        html += `<div class="finding-card" style="border-left-color:${ec}"><div class="finding-header"><span class="finding-engine" style="background:${ec}20;color:${ec}">${f.engine}</span><span class="finding-name">${escapeHtml(f.name)}</span><span class="finding-severity ${sevCls}">${f.severity}</span></div>`;
        if (f.quote) html += `<div class="finding-quote">"${escapeHtml(f.quote)}"</div>`;
        if (f.decoded) html += `<div class="finding-decoded">üí° ${escapeHtml(f.decoded)}</div>`;
        if (f.cialdini) html += `<div style="font-size:11px;color:var(--orange);margin:6px 0">üéØ Cialdini: ${escapeHtml(f.cialdini)}</div>`;
        if (f.legal) html += `<div class="finding-legal">‚öñÔ∏è ${escapeHtml(f.legal)}</div>`;
        if (f.ask) html += `<div class="finding-ask">‚ùì ${escapeHtml(f.ask)}</div>`;
        if (f.counter_moves) {
            html += `<div class="counter-moves"><div class="counter-move"><strong>üó£ Say:</strong> ${escapeHtml(f.counter_moves.what_to_say || '')}</div><div class="counter-move"><strong>üëÅ Spot:</strong> ${escapeHtml(f.counter_moves.recognize_it || '')}</div><div class="counter-move"><strong>üõ° Protect:</strong> ${escapeHtml(f.counter_moves.protect_yourself || '')}</div></div>`;
        }
        html += `</div>`;
    });
    html += `</div>`;

    // Legal notes
    if (a.legal_notes && a.legal_notes.length) {
        html += `<div class="legal-section"><div style="font-size:11px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">‚öñÔ∏è Legal Perspective</div>`;
        a.legal_notes.forEach(n => { html += `<div class="legal-note">${escapeHtml(n)}</div>`; });
        html += `</div>`;
    }

    html += `<div class="watermark"><span>analyzed by</span><div class="hf-badge">THE HUMAN FILTER v7</div><span>humanlayerai.com</span></div>`;
    html += `</div>`;
    document.getElementById('tab-verdict').innerHTML = html;
}

function renderXRay(a) {
    if (!a.xray || a.xray.length === 0) {
        document.getElementById('tab-xray').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text)">No X-Ray data available</div>';
        return;
    }
    const sevColors = { high: 'var(--red)', medium: 'var(--orange)', low: 'var(--yellow)', clean: 'var(--green)' };

    let html = `<div class="comparison-grid"><div class="comparison-col-header comp-original-header">üî¥ What They Said</div><div class="comparison-col-header comp-decoded-header">üü¢ What They Meant</div>`;
    a.xray.forEach(x => {
        const dotColor = sevColors[x.severity] || 'var(--text)';
        html += `<div class="comp-cell original"><span class="comp-severity-dot" style="background:${dotColor}"></span>${escapeHtml(x.original || '')}</div>`;
        html += `<div class="comp-cell decoded">${escapeHtml(x.decoded || '')}${x.cognitive_bias_used ? `<div style="font-size:10px;color:var(--purple);margin-top:4px">üß† ${escapeHtml(x.cognitive_bias_used)}</div>` : ''}</div>`;
    });
    html += `</div>`;

    // Cognitive distortions
    if (a.cognitive_distortions && a.cognitive_distortions.length) {
        html += `<div style="margin-top:20px"><div style="font-size:11px;font-weight:700;color:var(--pink);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üß† Cognitive Distortions Detected</div>`;
        a.cognitive_distortions.forEach(d => {
            html += `<div class="distortion-card"><div class="distortion-name">${escapeHtml(d.distortion)}</div><div class="distortion-quote">"${escapeHtml(d.quote)}"</div><div class="distortion-reframe">‚úÖ Reframe: ${escapeHtml(d.reframe)}</div></div>`;
        });
        html += `</div>`;
    }

    document.getElementById('tab-xray').innerHTML = html;
}

function renderProfile(a) {
    let html = '';

    // Kahneman System 1/2
    if (a.kahneman) {
        const k = a.kahneman;
        html += `<div class="profile-card"><div class="profile-section-title" style="color:#818cf8">üß† Kahneman System Analysis</div>`;
        html += `<div style="margin:10px 0"><span class="system-badge ${k.primary_system_targeted === 1 ? 'system1' : 'system2'}">Primary Target: System ${k.primary_system_targeted}</span></div>`;
        if (k.system1_triggers && k.system1_triggers.length) {
            html += `<div style="margin:8px 0"><strong style="font-size:11px;color:var(--red)">System 1 Triggers (Fast/Emotional):</strong>`;
            k.system1_triggers.forEach(t => { html += `<div style="font-size:12px;color:var(--text2);margin:4px 0 4px 12px">‚Ä¢ ${escapeHtml(t)}</div>`; });
            html += `</div>`;
        }
        if (k.system2_bypasses && k.system2_bypasses.length) {
            html += `<div style="margin:8px 0"><strong style="font-size:11px;color:var(--cyan)">System 2 Bypasses (Rational Override):</strong>`;
            k.system2_bypasses.forEach(t => { html += `<div style="font-size:12px;color:var(--text2);margin:4px 0 4px 12px">‚Ä¢ ${escapeHtml(t)}</div>`; });
            html += `</div>`;
        }
        if (k.debiasing_strategy) html += `<div style="font-size:12px;color:var(--green);margin-top:8px">üõ° Defense: ${escapeHtml(k.debiasing_strategy)}</div>`;
        html += `</div>`;
    }

    // 48 Laws of Power
    if (a.laws_of_power && a.laws_of_power.length) {
        html += `<div class="profile-card"><div class="profile-section-title" style="color:var(--gold)">üëë 48 Laws of Power Detected</div>`;
        a.laws_of_power.forEach(l => {
            html += `<div class="law-card"><div class="law-num">LAW ${l.law_number}</div><div class="law-name">${escapeHtml(l.law_name)}</div><div class="law-how">${escapeHtml(l.how_used)}</div>${l.counter_law ? `<div style="font-size:11px;color:var(--green);margin-top:4px">‚öîÔ∏è Counter: ${escapeHtml(l.counter_law)}</div>` : ''}</div>`;
        });
        html += `</div>`;
    }

    // Dark Triad
    if (a.dark_triad) {
        const dt = a.dark_triad;
        html += `<div class="profile-card"><div class="profile-section-title" style="color:#94a3b8">üé≠ Dark Triad Analysis</div>`;
        html += `<div class="dark-triad-meter">`;
        [{ label: 'Machiavellianism', val: dt.machiavellianism, color: '#6366f1' }, { label: 'Narcissism', val: dt.narcissism, color: '#f59e0b' }, { label: 'Psychopathy', val: dt.psychopathy, color: '#ef4444' }].forEach(item => {
            html += `<div class="dt-item"><div class="dt-label">${item.label}</div><div class="dt-bar"><div class="dt-fill" style="width:${item.val}%;background:${item.color}"></div></div><div class="dt-value" style="color:${item.color}">${item.val}/100</div></div>`;
        });
        html += `</div>`;
        if (dt.summary) html += `<div class="profile-text" style="margin-top:12px">${escapeHtml(dt.summary)}</div>`;
        html += `</div>`;
    }

    // Neurochemical triggers
    if (a.neurochemical_triggers && a.neurochemical_triggers.length) {
        html += `<div class="profile-card"><div class="profile-section-title" style="color:#fbbf24">üß™ Neurochemical Triggers</div>`;
        const neuroClasses = { dopamine: 'neuro-dopamine', cortisol: 'neuro-cortisol', oxytocin: 'neuro-oxytocin', serotonin: 'neuro-serotonin' };
        html += `<div style="margin:8px 0">`;
        a.neurochemical_triggers.forEach(n => {
            const cls = neuroClasses[n.chemical] || 'neuro-dopamine';
            html += `<div style="margin:8px 0;padding:10px;background:var(--bg);border-radius:8px"><span class="neuro-tag ${cls}">${n.chemical}</span><div style="font-size:12px;color:var(--text2);margin-top:6px">üéØ ${escapeHtml(n.trigger)}</div><div style="font-size:11px;color:var(--green);margin-top:4px">üõ° ${escapeHtml(n.defense)}</div></div>`;
        });
        html += `</div></div>`;
    }

    if (!html) html = '<div style="padding:20px;text-align:center;color:var(--text)">No profile data available</div>';
    document.getElementById('tab-profile').innerHTML = html;
}

function renderCoach(a) {
    let html = '';
    if (a.response) {
        html += `<div class="coach-card"><div class="profile-section-title" style="color:var(--green)">üí¨ Strategic Response</div><div class="profile-text" style="margin-bottom:12px">A psychologically informed response that neutralizes detected manipulation while maintaining your position.</div><div class="coach-response">${escapeHtml(a.response)}</div><button class="copy-response-btn" onclick="navigator.clipboard.writeText(lastAnalysis.response);toast('Response copied!')">üìã Copy Response</button></div>`;
    }
    if (a.vibe) {
        html += `<div class="coach-card"><div class="profile-section-title" style="color:var(--orange)">üìä Vibe Check</div>`;
        if (a.vibe.tone) html += `<div style="font-size:14px;margin:8px 0">${escapeHtml(a.vibe.tone)}</div>`;
        if (a.vibe.red_flags) html += `<div style="font-size:12px;color:var(--red);margin:6px 0">üö© ${escapeHtml(a.vibe.red_flags)}</div>`;
        if (a.vibe.pattern) html += `<div style="font-size:12px;color:var(--text);margin:6px 0">üìê Pattern: ${escapeHtml(a.vibe.pattern)}</div>`;
        html += `</div>`;
    }
    if (!html) html = '<div style="padding:20px;text-align:center;color:var(--text)">Run an analysis to see coaching suggestions</div>';
    document.getElementById('tab-coach').innerHTML = html;
}

function showTab(tab) {
    document.querySelectorAll('.result-tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(tab)));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tab));
}

// === INIT ===
function init() {
    // Build presets
    const pc = document.getElementById('presetsContainer');
    Object.entries(PRESETS).forEach(([key, p]) => {
        const btn = document.createElement('button');
        btn.className = 'preset-card';
        btn.innerHTML = `<div class="preset-emoji">${p.emoji}</div><div class="preset-label">${p.label}</div>`;
        btn.onclick = () => {
            document.getElementById('messageInput').value = p.text;
            document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
            btn.classList.add('selected');
            runAnalysis();
        };
        pc.appendChild(btn);
    });

    // Char counter
    document.getElementById('messageInput').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length + ' chars';
    });

    // Embed mode
    if (isEmbedMode()) {
        document.getElementById('header').classList.add('embed-hidden');
        document.getElementById('footer').classList.add('embed-hidden');
    }

    // Prompt for API key on first visit
    if (!getApiKey()) setTimeout(() => promptForApiKey(), 2000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
