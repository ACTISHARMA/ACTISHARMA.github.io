<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The Human Filter - Decode manipulation, understand psychology, respond strategically.">
    <meta name="theme-color" content="#0f0f1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Human Filter">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230f0f1e' width='180' height='180'/><circle cx='90' cy='90' r='70' fill='none' stroke='%2300d9ff' stroke-width='3'/><path d='M 90 50 Q 110 70 90 90 Q 70 70 90 50' fill='%2300d9ff'/></svg>">
    <title>The Human Filter - Manipulation Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1e;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --fg-primary: #f5f5f7;
            --fg-secondary: #b0b0b8;
            --accent-purple: #a78bfa;
            --accent-blue: #3b82f6;
            --accent-cyan: #00d9ff;
            --accent-teal: #14b8a6;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #2ed573;
            --glass-blur: 16px;
            --glass-opacity: 0.1;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a0033 50%, var(--bg-tertiary) 100%);
            color: var(--fg-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(167, 139, 250, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .particle-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0; }
            10% { opacity: 0.5; }
            50% { opacity: 1; }
            90% { opacity: 0.5; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-purple), var(--accent-cyan));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-teal));
        }

        /* Main layout */
        .main-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 217, 255, 0.1);
            background: rgba(15, 15, 30, 0.7);
            backdrop-filter: blur(var(--glass-blur));
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .logo-text {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-tagline {
            font-size: 0.65rem;
            color: var(--fg-secondary);
            opacity: 0.7;
            font-style: italic;
            letter-spacing: 0.5px;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-purple);
            animation: fadeIn 0.6s ease-out 0.2s both;
            position: relative;
            cursor: pointer;
        }

        .level-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 12px;
            padding: 1rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--fg-secondary);
            line-height: 1.8;
            width: 220px;
            z-index: 200;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .level-badge:hover .level-tooltip,
        .level-tooltip.show {
            display: block;
        }

        /* Image upload area */
        .upload-area {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .upload-btn {
            padding: 0.6rem 1.2rem;
            background: rgba(167, 139, 250, 0.1);
            border: 1px dashed rgba(167, 139, 250, 0.4);
            border-radius: 8px;
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-btn:hover {
            background: rgba(167, 139, 250, 0.2);
            border-color: var(--accent-purple);
        }

        .upload-status {
            font-size: 0.8rem;
            color: var(--fg-secondary);
        }

        .upload-preview {
            max-width: 200px;
            max-height: 100px;
            border-radius: 8px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-number {
            font-weight: 700;
            font-size: 1rem;
        }

        .level-name {
            font-weight: 400;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Main content */
        .content {
            flex: 1;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem 1.5rem;
        }

        /* Section title */
        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeIn 0.6s ease-out;
        }

        .subtitle {
            font-size: 1.05rem;
            color: var(--fg-secondary);
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.1s both;
        }

        /* Input section */
        .input-section {
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 1.5rem;
            background: rgba(26, 26, 46, 0.5);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            color: var(--fg-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(var(--glass-blur));
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(26, 26, 46, 0.8);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        textarea::placeholder {
            color: var(--fg-secondary);
            opacity: 0.6;
        }

        /* Presets */
        .presets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .preset-btn {
            padding: 0.75rem;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 8px;
            color: var(--fg-primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }

        .preset-icon {
            font-size: 1.5rem;
        }

        .preset-btn:hover {
            background: rgba(167, 139, 250, 0.2);
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(167, 139, 250, 0.15);
        }

        /* Control buttons */
        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            color: white;
            box-shadow: 0 8px 24px rgba(167, 139, 250, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(167, 139, 250, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            color: var(--accent-cyan);
        }

        .btn-secondary:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Results section */
        .results-container {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }

        .results-container.show {
            display: block;
        }

        /* Score ring */
        .score-section {
            margin-bottom: 2rem;
            animation: staggerReveal 0.6s ease-out 0.3s both;
        }

        @keyframes staggerReveal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            padding: 2rem;
            background: rgba(26, 26, 46, 0.4);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
        }

        .score-ring-wrapper {
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }

        .score-ring {
            width: 100%;
            height: 100%;
        }

        .score-ring-bg {
            fill: none;
            stroke: rgba(0, 217, 255, 0.1);
            stroke-width: 8;
        }

        .score-ring-progress {
            fill: none;
            stroke: url(#scoreGradient);
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 70px 70px;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--fg-secondary);
            margin-top: 0.25rem;
        }

        .score-info {
            flex: 1;
            min-width: 250px;
        }

        .vibe-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--fg-primary);
        }

        .vibe-text {
            color: var(--fg-secondary);
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .fact-box {
            padding: 0.75rem 1rem;
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid var(--accent-cyan);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--fg-secondary);
            font-style: italic;
        }

        /* === ANIMATED SCORE === */
        .score-ring-progress { transition: stroke-dashoffset 1.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .score-number.animating { animation: scoreGlow 1.8s ease-out; }
        @keyframes scoreGlow {
            0% { filter: blur(2px); opacity: 0.5; }
            50% { filter: blur(0); opacity: 1; text-shadow: 0 0 20px rgba(0,217,255,0.5); }
            100% { filter: blur(0); opacity: 1; text-shadow: none; }
        }
        .score-container.revealed .score-ring-wrapper { animation: scorePop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 1.6s both; }
        @keyframes scorePop { from { transform: scale(1); } 50% { transform: scale(1.08); } to { transform: scale(1); } }

        /* === CONTEXT SELECTOR === */
        .context-selector {
            display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;
            padding: 0.75rem 1rem; background: rgba(26,26,46,0.4);
            border: 1px solid rgba(0,217,255,0.1); border-radius: 10px;
        }
        .context-selector label { color: var(--fg-secondary); font-size: 0.85rem; white-space: nowrap; }
        .context-selector select {
            flex: 1; padding: 0.6rem 1rem; background: rgba(0,217,255,0.05);
            border: 1px solid rgba(0,217,255,0.15); border-radius: 8px;
            color: var(--fg-primary); font-size: 0.9rem; font-family: 'Inter', sans-serif;
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2300d9ff' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center;
        }
        .context-selector select option { background: #1a1a2e; color: var(--fg-primary); }

        /* === SHARE SCORE CARD === */
        .share-score-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.2rem; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            border: none; border-radius: 8px; color: white; font-weight: 600;
            font-size: 0.85rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .share-score-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,217,255,0.3); }

        /* === ONBOARDING TOUR === */
        .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9998; }
        .tour-tooltip {
            position: fixed; z-index: 9999; background: linear-gradient(135deg, #1a1a3e, #0f0f2e);
            border: 1px solid var(--accent-cyan); border-radius: 12px;
            padding: 1.25rem 1.5rem; max-width: 300px; box-shadow: 0 8px 30px rgba(0,217,255,0.2);
            animation: tourFadeIn 0.3s ease-out;
        }
        @keyframes tourFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tour-tooltip h4 { color: var(--accent-cyan); margin: 0 0 0.5rem; font-size: 0.95rem; }
        .tour-tooltip p { color: var(--fg-secondary); font-size: 0.85rem; margin: 0 0 1rem; line-height: 1.5; }
        .tour-tooltip .tour-nav { display: flex; gap: 0.5rem; justify-content: flex-end; }
        .tour-tooltip .tour-btn {
            padding: 0.4rem 1rem; border-radius: 6px; font-size: 0.8rem;
            cursor: pointer; font-weight: 600; border: none;
        }
        .tour-tooltip .tour-btn-next { background: var(--accent-cyan); color: #0f0f1e; }
        .tour-tooltip .tour-btn-skip { background: transparent; color: var(--fg-secondary); border: 1px solid rgba(255,255,255,0.1); }
        .tour-tooltip .tour-step { color: var(--fg-secondary); font-size: 0.7rem; margin-bottom: 0.5rem; }
        .tour-highlight { position: relative; z-index: 9999; box-shadow: 0 0 0 4px rgba(0,217,255,0.4), 0 0 20px rgba(0,217,255,0.2); border-radius: 12px; }

        /* === MICRO-ANIMATIONS === */
        .finding-card, .xray-item, .red-flag-card { opacity: 0; transform: translateY(20px); animation: cardSlideIn 0.4s ease-out forwards; }
        .finding-card:nth-child(1), .xray-item:nth-child(1), .red-flag-card:nth-child(1) { animation-delay: 0.05s; }
        .finding-card:nth-child(2), .xray-item:nth-child(2), .red-flag-card:nth-child(2) { animation-delay: 0.15s; }
        .finding-card:nth-child(3), .xray-item:nth-child(3), .red-flag-card:nth-child(3) { animation-delay: 0.25s; }
        .finding-card:nth-child(4), .xray-item:nth-child(4), .red-flag-card:nth-child(4) { animation-delay: 0.35s; }
        .finding-card:nth-child(5), .xray-item:nth-child(5) { animation-delay: 0.45s; }
        .finding-card:nth-child(6), .xray-item:nth-child(6) { animation-delay: 0.55s; }
        @keyframes cardSlideIn { to { opacity: 1; transform: translateY(0); } }
        .severity-badge { animation: badgePulse 0.3s ease-out 0.8s both; }
        @keyframes badgePulse { 0% { transform: scale(0.8); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        /* === MIRROR MODE === */
        .mirror-toggle {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.6rem 1rem; background: rgba(26,26,46,0.4);
            border: 1px solid rgba(168,85,247,0.15); border-radius: 10px;
            margin-top: 0.75rem; cursor: pointer; transition: all 0.3s;
        }
        .mirror-toggle:hover { border-color: rgba(168,85,247,0.4); }
        .mirror-toggle.active { border-color: var(--accent-purple); background: rgba(168,85,247,0.08); }
        .mirror-toggle .mirror-icon { font-size: 1.2rem; }
        .mirror-toggle .mirror-label { font-size: 0.85rem; color: var(--fg-secondary); }
        .mirror-toggle.active .mirror-label { color: var(--accent-purple); }
        .mirror-toggle .mirror-switch {
            width: 36px; height: 20px; background: rgba(255,255,255,0.1);
            border-radius: 10px; position: relative; margin-left: auto; transition: background 0.3s;
        }
        .mirror-toggle.active .mirror-switch { background: var(--accent-purple); }
        .mirror-toggle .mirror-switch::after {
            content: ''; position: absolute; width: 16px; height: 16px;
            background: white; border-radius: 50%; top: 2px; left: 2px;
            transition: transform 0.3s;
        }
        .mirror-toggle.active .mirror-switch::after { transform: translateX(16px); }

        /* === REAL-TIME PREVIEW BAR === */
        .realtime-bar {
            height: 4px; border-radius: 2px; background: rgba(255,255,255,0.05);
            margin-top: 0.5rem; overflow: hidden; transition: opacity 0.3s;
        }
        .realtime-bar-fill {
            height: 100%; width: 0%; border-radius: 2px;
            transition: width 0.4s ease-out, background 0.4s;
            background: var(--success);
        }
        .realtime-hint {
            font-size: 0.75rem; color: var(--fg-secondary); margin-top: 0.3rem;
            min-height: 1.1em; transition: color 0.3s;
        }

        /* === THEME TOGGLE === */
        .theme-toggle {
            width: 32px; height: 32px; border-radius: 50%;
            border: 1px solid rgba(0,217,255,0.2); background: rgba(0,217,255,0.05);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: all 0.3s; margin-right: 0.75rem;
        }
        .theme-toggle:hover { border-color: var(--accent-cyan); background: rgba(0,217,255,0.1); }

        /* Light mode overrides */
        body.light-mode { --bg-primary: #f5f5fa; --bg-secondary: #e8e8f0; --fg-primary: #1a1a2e; --fg-secondary: #555570; }
        body.light-mode .main-container { background: rgba(255,255,255,0.85); }
        body.light-mode header { background: rgba(245,245,250,0.9); border-bottom-color: rgba(0,0,0,0.08); }
        body.light-mode .preset-btn { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); color: #333; }
        body.light-mode .preset-btn:hover { background: rgba(0,0,0,0.08); }
        body.light-mode textarea { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.1); color: #1a1a2e; }
        body.light-mode .score-container, body.light-mode .compare-toggle,
        body.light-mode .context-selector, body.light-mode .mirror-toggle { background: rgba(0,0,0,0.03); border-color: rgba(0,0,0,0.08); }
        body.light-mode .tab-btn { color: #666; }
        body.light-mode .tab-btn.active { color: var(--accent-purple); }
        body.light-mode .finding-card, body.light-mode .xray-item { background: rgba(0,0,0,0.02); border-color: rgba(0,0,0,0.06); }
        body.light-mode .fact-box { background: rgba(0,217,255,0.05); }
        body.light-mode .vibe-title, body.light-mode .score-info { color: #1a1a2e; }
        body.light-mode .particle-bg { opacity: 0.15; }

        /* === DASHBOARD STATS === */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card {
            padding: 1rem; text-align: center; border-radius: 10px;
            background: rgba(0,217,255,0.04); border: 1px solid rgba(0,217,255,0.1);
        }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan); font-family: 'Space Grotesk', sans-serif; }
        .stat-label { font-size: 0.75rem; color: var(--fg-secondary); margin-top: 0.25rem; }
        .streak-fire { color: #ff6b7a; font-size: 1.5rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(0, 217, 255, 0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 1.25rem 1.5rem;
            background: none;
            border: none;
            color: var(--fg-secondary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Space Grotesk', sans-serif;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--accent-cyan);
        }

        .tab-btn.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .tab-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
            font-weight: 400;
            margin-top: 0.25rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Finding cards */
        .findings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .finding-card {
            padding: 1.5rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .finding-card:hover {
            background: rgba(26, 26, 46, 0.5);
            border-color: var(--accent-cyan);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 217, 255, 0.15);
        }

        .finding-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), rgba(0, 217, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .finding-card:hover::before {
            opacity: 1;
        }

        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .finding-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-purple);
        }

        .finding-severity {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(255, 71, 87, 0.2);
            color: #ff6b7a;
        }

        .severity-medium {
            background: rgba(255, 165, 2, 0.2);
            color: #ffb23a;
        }

        .severity-low {
            background: rgba(46, 213, 115, 0.2);
            color: #6edd89;
        }

        .finding-principle {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(167, 139, 250, 0.15);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .finding-principle.tooltip-trigger {
            cursor: help;
            transition: all 0.2s ease;
        }

        .finding-principle.tooltip-trigger:hover {
            background: rgba(167, 139, 250, 0.25);
            border-color: var(--accent-purple);
        }

        .finding-decode {
            color: var(--fg-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            position: relative;
            z-index: 1;
        }

        .finding-counter {
            padding: 0.75rem;
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid var(--accent-cyan);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            position: relative;
            z-index: 1;
        }

        /* X-Ray section */
        .xray-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .xray-item {
            padding: 1.5rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
            transition: all 0.3s ease;
        }

        .xray-item:hover {
            background: rgba(26, 26, 46, 0.5);
            border-color: var(--accent-cyan);
        }

        .xray-original {
            margin-bottom: 1rem;
        }

        .xray-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--fg-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .xray-text {
            padding: 0.75rem;
            background: rgba(0, 217, 255, 0.05);
            border-radius: 6px;
            color: var(--fg-primary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .xray-decode {
            padding: 0.75rem;
            background: rgba(167, 139, 250, 0.05);
            border-left: 3px solid var(--accent-purple);
            border-radius: 6px;
            color: var(--accent-purple);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Profile section */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .profile-item {
            padding: 1.5rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
            animation: slideUp 0.6s ease-out;
        }

        .profile-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--fg-secondary);
            text-transform: uppercase;
            margin-bottom: 0.75rem;
            opacity: 0.7;
        }

        .profile-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .profile-description {
            font-size: 0.9rem;
            color: var(--fg-secondary);
            line-height: 1.6;
        }

        /* Compare toggle */
        .compare-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compare-toggle:hover {
            background: rgba(26, 26, 46, 0.5);
            border-color: var(--accent-cyan);
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            position: relative;
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch.active {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .compare-text {
            flex: 1;
        }

        .compare-text strong {
            color: var(--fg-primary);
        }

        /* Coach section */
        .coach-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .coach-item {
            padding: 1.5rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
            animation: slideUp 0.6s ease-out;
        }

        .coach-item h4 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 0.75rem;
        }

        .coach-item p {
            color: var(--fg-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Share buttons */
        .share-section {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .share-btn {
            padding: 0.5rem 1rem;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: var(--accent-cyan);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .share-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
        }

        /* History */
        .history-section {
            margin-top: 2rem;
        }

        .history-timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .history-item {
            padding: 1.25rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .history-item:hover {
            background: rgba(26, 26, 46, 0.5);
            border-color: var(--accent-cyan);
        }

        .history-preview {
            flex: 1;
            min-width: 0;
        }

        .history-text {
            font-size: 0.9rem;
            color: var(--fg-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--fg-secondary);
            opacity: 0.6;
        }

        .history-score {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        /* Feedback form */
        .feedback-section {
            margin-top: 3rem;
            padding: 2rem;
            background: rgba(26, 26, 46, 0.3);
            border: 1px solid rgba(0, 217, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(var(--glass-blur));
        }

        .feedback-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--fg-primary);
        }

        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .rating-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .star-btn {
            width: 48px;
            height: 48px;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
            color: var(--fg-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .star-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
            transform: scale(1.1);
        }

        .star-btn.active {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            border-color: var(--accent-cyan);
            color: white;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            background: rgba(15, 15, 30, 0.5);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
            color: var(--fg-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        /* Onboarding */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 30, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .onboarding-overlay.show {
            display: flex;
        }

        .onboarding-content {
            max-width: 600px;
            text-align: center;
            animation: slideUp 0.6s ease-out;
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
        }

        .onboarding-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .onboarding-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .onboarding-text {
            color: var(--fg-secondary);
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 2rem;
        }

        .onboarding-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(15, 15, 30, 0.95);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            max-width: 300px;
            backdrop-filter: blur(var(--glass-blur));
            z-index: 500;
            display: none;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s ease-out;
        }

        .tooltip.show {
            display: block;
        }

        .tooltip-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .tooltip-text {
            color: var(--fg-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid rgba(46, 213, 115, 0.5);
            border-radius: 8px;
            color: #6edd89;
            z-index: 900;
            display: none;
            animation: slideUp 0.4s ease-out;
            max-width: 400px;
            margin-left: auto;
            margin-right: 0;
        }

        .toast.show {
            display: block;
        }

        /* Footer */
        footer {
            padding: 2rem 1.5rem;
            border-top: 1px solid rgba(0, 217, 255, 0.1);
            text-align: center;
            color: var(--fg-secondary);
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.75rem;
            }

            .header-content {
                flex-direction: column;
                gap: 0.75rem;
            }

            .logo-text {
                font-size: 1.1rem;
            }

            .logo-tagline {
                font-size: 0.6rem;
            }

            .upload-area {
                flex-wrap: wrap;
            }

            .level-tooltip {
                right: -20px;
                width: 200px;
            }

            .content {
                padding: 1.5rem 1rem;
            }

            .score-container {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .score-info {
                min-width: 100%;
            }

            .presets-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .tabs {
                overflow-x: auto;
            }

            .findings-grid {
                grid-template-columns: 1fr;
            }

            .profile-grid {
                grid-template-columns: 1fr;
            }

            .coach-grid {
                grid-template-columns: 1fr;
            }

            .history-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .history-score {
                align-self: flex-start;
            }
        }

        @media (max-width: 400px) {
            h1 {
                font-size: 1.4rem;
            }

            .subtitle {
                font-size: 0.85rem;
            }

            .content {
                padding: 1rem 0.75rem;
            }

            .presets-grid {
                gap: 0.5rem;
            }

            .preset-btn {
                padding: 0.6rem;
                font-size: 0.75rem;
                min-height: 44px;
            }

            .preset-btn .preset-icon {
                font-size: 1.2rem;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                min-height: 44px;
            }

            .btn {
                min-height: 44px;
            }

            .share-btn {
                min-height: 44px;
                padding: 0.6rem 1rem;
            }

            .score-ring-wrapper {
                width: 110px;
                height: 110px;
            }
        }
    </style>
</head>
<body>
    <div class="particle-bg" id="particleBg"></div>

    <div class="main-container">
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">&#x3D5;</div>
                    <div>
                        <div class="logo-text">HUMAN FILTER</div>
                        <div class="logo-tagline">because the bullshit detector was taken</div>
                    </div>
                </div>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark mode">&#x1F319;</button>
                <div class="level-badge" id="levelBadge" onclick="showLevelTooltip()">
                    <span class="level-number" id="levelNumber">1</span>
                    <div>
                        <div class="level-name" id="levelName">Novice</div>
                    </div>
                    <div class="level-tooltip" id="levelTooltip">
                        <strong>Your Detection Level</strong><br>
                        Scan more messages to level up!<br><br>
                        <span style="color:var(--accent-purple)">Lv 1</span> Novice (0-5 scans)<br>
                        <span style="color:var(--accent-blue)">Lv 2</span> Aware (6-15 scans)<br>
                        <span style="color:var(--accent-cyan)">Lv 3</span> Decoder (16-30 scans)<br>
                        <span style="color:var(--success)">Lv 4</span> Master Filter (30+ scans)
                    </div>
                </div>
            </div>
        </header>

        <div class="content">
            <h1>Decode Manipulation</h1>
            <p class="subtitle">Paste any message. We analyze the psychology behind it.</p>

            <div class="input-section">
                <div class="context-selector">
                    <label for="contextSelect">Who sent this?</label>
                    <select id="contextSelect">
                        <option value="auto">Auto-detect</option>
                        <option value="boss">Boss / Manager</option>
                        <option value="date">Date / Romantic Interest</option>
                        <option value="family">Family Member</option>
                        <option value="stranger">Stranger / Cold DM</option>
                        <option value="sales">Salesperson / Recruiter</option>
                        <option value="friend">Friend / Peer</option>
                        <option value="ex">Ex-Partner</option>
                        <option value="social">Social Media / Influencer</option>
                    </select>
                </div>
                <div class="presets-grid" id="presetsGrid"></div>

                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="Paste a message, email, DM, post, or any text you want to analyze. We'll decode what they really mean." oninput="updateRealtimePreview()"></textarea>
                    <div class="realtime-bar"><div class="realtime-bar-fill" id="realtimeBarFill"></div></div>
                    <div class="realtime-hint" id="realtimeHint"></div>
                </div>

                <div class="upload-area">
                    <label class="upload-btn" for="imageUpload">
                        <span>&#x1F4F7;</span> Upload Screenshot
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                    <span class="upload-status" id="uploadStatus"></span>
                    <img id="uploadPreview" class="upload-preview" style="display:none;">
                    <button id="uploadClearBtn" style="display:none;padding:0.4rem 0.8rem;background:rgba(255,71,87,0.15);border:1px solid rgba(255,71,87,0.3);border-radius:6px;color:#ff6b7a;cursor:pointer;font-size:0.8rem;font-weight:600;" onclick="clearUpload()">&#10005; Clear</button>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" id="analyzeBtn">
                        <span>&#x1F50D;</span> Analyze
                    </button>
                    <button class="btn btn-secondary btn-small" id="clearBtn">Clear</button>
                    <button class="btn btn-secondary btn-small" id="historyBtn">&#x1F4CB; History</button>
                </div>
            </div>

            <div class="compare-toggle" id="rephraseToggle" onclick="toggleRephraseMode()">
                <div class="toggle-switch" id="toggleSwitch"></div>
                <div class="compare-text">
                    <strong>Rephrase Mode</strong><br>
                    <small>Paste your message - we remove the manipulation</small>
                </div>
            </div>

            <div class="mirror-toggle" id="mirrorToggle" onclick="toggleMirrorMode()">
                <span class="mirror-icon">&#x1FA9E;</span>
                <span class="mirror-label">Mirror Mode &mdash; Analyze your own writing</span>
                <div class="mirror-switch"></div>
            </div>

            <div id="rephraseInputs" style="display: none; margin-bottom: 2rem;">
                <div class="input-wrapper" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--fg-secondary);">Your draft message</label>
                    <textarea id="rephraseInput" placeholder="Paste the message you want to send. We will flag any manipulation patterns and offer a cleaner version..." style="min-height: 140px;"></textarea>
                </div>
                <button class="btn btn-primary" id="rephraseBtn" onclick="rephraseMessage()">Scan and Rephrase</button>
                <div id="rephraseOutput" style="display:none; margin-top:1.5rem;"></div>
            </div>

            <div class="results-container" id="resultsContainer">
                <!-- Score section -->
                <div class="score-section" id="scoreSection"></div>

                <!-- Tabs -->
                <div class="tabs" id="tabs"></div>
                <div id="xrayTab" class="tab-content active"></div>
                <div id="findingsTab" class="tab-content"></div>
                <div id="profileTab" class="tab-content"></div>
                <div id="coachTab" class="tab-content"></div>

                <!-- Share -->
                <div class="share-section" id="shareSection"></div>

                <!-- History -->
                <div class="history-section" id="historySection"></div>

                <!-- Feedback -->
                <div class="feedback-section" style="margin-top:2rem;padding:1.5rem;background:rgba(26,26,46,0.4);border:1px solid rgba(0,217,255,0.1);border-radius:12px;text-align:center;">
                    <h3 style="color:var(--fg-primary);margin-bottom:0.5rem;">Help us improve</h3>
                    <p style="color:var(--fg-secondary);font-size:0.9rem;margin-bottom:1rem;">Your feedback shapes the next version.</p>
                    <a href="mailto:hello@aakarshsharma.com?subject=Human%20Filter%20Feedback&body=Score%3A%20%0AWhat%20worked%3A%20%0AWhat%20didn%27t%3A%20" id="feedbackFormLink" target="_blank" class="btn btn-primary" style="display:inline-flex;text-decoration:none;">Share Feedback &#x2192;</a>
                </div>
            </div>
        </div>

        <footer style="padding:2rem 1.5rem;border-top:1px solid rgba(0,217,255,0.1);text-align:center;">
            <div style="max-width:1000px;margin:0 auto;">
                <!-- Add to Home Screen CTA -->
                <div style="margin-bottom:2rem;padding:1.25rem;background:linear-gradient(135deg,rgba(167,139,250,0.1),rgba(0,217,255,0.1));border:1px solid rgba(167,139,250,0.2);border-radius:12px;">
                    <div style="font-size:1.2rem;margin-bottom:0.5rem;">&#x1F4F1; Add to Home Screen</div>
                    <p style="color:var(--fg-secondary);font-size:0.85rem;line-height:1.6;margin-bottom:0.5rem;">Use The Human Filter like an app &mdash; no app store needed.</p>
                    <p style="color:var(--fg-secondary);font-size:0.8rem;line-height:1.8;">
                        <strong style="color:var(--fg-primary);">iPhone:</strong> Tap Share &#x2197; &#x2192; Add to Home Screen<br>
                        <strong style="color:var(--fg-primary);">Android:</strong> Tap &#x22EE; &#x2192; Add to Home Screen<br>
                        <strong style="color:var(--fg-primary);">Desktop:</strong> Click install icon in address bar
                    </p>
                </div>

                <!-- Social links -->
                <div style="display:flex;justify-content:center;gap:1.25rem;flex-wrap:wrap;margin-bottom:1.5rem;">
                    <a href="https://www.linkedin.com/in/aakarsh-sharma-ai/" target="_blank" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">LinkedIn</a>
                    <a href="https://www.youtube.com/@humanlayerAI" target="_blank" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">YouTube</a>
                    <a href="https://www.instagram.com/humanlayerai/" target="_blank" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">Instagram</a>
                    <a href="https://medium.com/@humanlayerAI" target="_blank" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">Medium</a>
                    <a href="mailto:hello@aakarshsharma.com" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">Email</a>
                    <a href="https://calendly.com/humanlayerai" target="_blank" style="color:var(--accent-cyan);text-decoration:none;font-size:0.85rem;">Book a Call</a>
                </div>

                <p style="color:var(--fg-secondary);font-size:0.8rem;">Built by <a href="https://aakarshsharma.com" style="color:var(--accent-purple);text-decoration:none;">Aakarsh Sharma</a> &middot; Human Layer AI &middot; Law &#xD7; Psychology &#xD7; AI</p>
            </div>
        </footer>
    </div>

    <!-- Onboarding -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-content">
            <div class="onboarding-step active">
                <div class="onboarding-icon">&#x1F4DD;</div>
                <h2 class="onboarding-title">Paste Any Message</h2>
                <p class="onboarding-text">DMs, emails, posts, forwarded texts&mdash;if it feels off, paste it here. We'll analyze what's really going on.</p>
                <div class="onboarding-controls">
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next</button>
                    <button class="btn btn-secondary" onclick="skipOnboarding()">Skip</button>
                </div>
            </div>

            <div class="onboarding-step">
                <div class="onboarding-icon">&#x1F9E0;</div>
                <h2 class="onboarding-title">We Decode the Manipulation</h2>
                <p class="onboarding-text">Using psychology, persuasion frameworks, and pattern recognition, we expose the tactics being used to influence you.</p>
                <div class="onboarding-controls">
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next</button>
                    <button class="btn btn-secondary" onclick="skipOnboarding()">Skip</button>
                </div>
            </div>

            <div class="onboarding-step">
                <div class="onboarding-icon">&#x2728;</div>
                <h2 class="onboarding-title">You Decide Freely</h2>
                <p class="onboarding-text">No judgment. You're in control. Get insights, strategic responses, and the psychology behind every tactic.</p>
                <div class="onboarding-controls">
                    <button class="btn btn-primary" onclick="skipOnboarding()">Let's Go</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========================
        // PATTERNS & ANALYSIS ENGINE
        // ========================

        const PATTERNS = {
            // === PERSUASION ENGINE (Cialdini) ===
            scarcity: { re: /\b(only \d|limited|last chance|running out|few (spots|seats|left)|deadline (today|tomorrow|approaching|expires|is (today|tomorrow|soon|close|near))|expires|window closes|price (doubles|increases)|act now|before (it's|it is) gone|(won't|will not) last|exclusive access|\d+ hours|moving fast|spots? left|oversubscribed|not for everyone|lot of interest|deposit today|while (supplies|stocks?) last|selling out|almost gone|hurry|(don't|do not) miss|closing soon|offer ends|first come|seats? filling|one.?time|disappear|vanishing|dwindling|scarce)\b/gi, principle: 'Scarcity', engine: 'PERSUASION', sev: 'high', decode: 'Creating artificial urgency to bypass your rational decision-making.', legal: 'Artificial scarcity in commercial contexts may constitute deceptive trade practices under consumer protection laws.' },
            authority: { re: /\b(CEO|expert|doctors? (say|recommend|hate|suggest|advise|agree|confirm|warn|don't want)|scientist|research shows|studies (show|prove|indicate)|according to|professor|certified|award-winning|years of experience|personally asked|top VCs?|industry leader|Harvard|Stanford|MIT|PhD|M\.?D\.?|board certified|published|peer.?reviewed|leading authority|world.?renowned|bestselling author|as seen on|featured in|endorsed by|backed by science)\b/gi, principle: 'Authority', engine: 'PERSUASION', sev: 'medium', decode: 'Leveraging authority figures or credentials to make claims seem unquestionable.', legal: 'False claims of authority or credentials may violate advertising standards and professional licensing laws.' },
            social_proof: { re: /\b(everyone (is|says|knows|agrees|thinks|does|else)|others would|millions|most people|trending|viral|inner circle|handpick(ed)?|join (\d+\+?|thousands)|best-selling|top-rated|others are|people love|would never treat|most (brides|people|clients|users) choose|no one will ever|waking up|people are saying|the whole team|everybody knows|all my friends|nobody does that|who does that|normal people|any reasonable person|the consensus|widely accepted|growing movement|wave of support|bandwagon|herd)\b/gi, principle: 'Social Proof', engine: 'PERSUASION', sev: 'medium', decode: 'Using the behavior of others to pressure you into conformity.', legal: 'Fabricated testimonials or social proof claims can violate FTC endorsement guidelines.' },
            reciprocity: { re: /\b(I('ve| have) (done|given|sacrificed|gone out of my way)|after everything|I gave up|my sacrifices|I did this for you|you owe|repay|as a favor|making an exception|holding it for you|I went out of my way|I put in effort|I (spent|invested) (time|money|energy)|the least you (can|could)|I dropped everything|I rearranged|I made time|I prioritized you|I chose you over|remember when I)\b/gi, principle: 'Reciprocity', engine: 'PERSUASION', sev: 'high', decode: 'Creating a sense of obligation by highlighting past favors - real or exaggerated.', legal: 'Emotional debts have no legal standing. Past voluntary actions don\'t create enforceable obligations.' },
            liking: { re: /\b(I('ve| have) never felt|(you're|you are) (different|special|the only|perfect|amazing|interesting|incredible|brilliant|talented|gifted|so smart|so good)|we (click|connect)|I feel like (I('ve| have) known you|we already know)|really impressed|(you'd|you would) be perfect|yours stood out|love what you|see potential in you|believe in your|(don't|do not) usually (message|reach out|do this)|something about (you|your)|spoke to me|FIRE|amazing energy|stood out|(you're|you are) not like|I admire|you inspire|I respect you so much|I look up to you|(I'm|I am) in awe|what a (great|wonderful|fantastic|brilliant) (person|mind|job|idea|point)|you always know|(you're|you are) the best|no one (else )?(does it|can|could)|you have (such|a) (gift|talent|way|knack)|I learn so much from you|(you're|you are) literally|obsessed with your|love your (energy|vibe|work|mind|style)|you have been (chosen|selected|picked|handpicked)|we see something (special|unique|different) in you|not everyone gets (this|an?))\b/gi, principle: 'Liking', engine: 'PERSUASION', sev: 'medium', decode: 'Flattery and manufactured connection to lower your defenses.', legal: 'While flattery itself isn\'t illegal, it\'s a common precursor to fraud and undue influence.' },
            commitment: { re: /\b(you (agreed|promised|committed)|you said you (would|will|could)|sign(ing)? (by|below|now|today)|(don't|do not) go back on|you already|consistent with|maintain your|standard agreement|you (irrevocably )?agree|you gave your word|you shook on it|we had a deal|remember you said|but you told me|you (can't|cannot) just change|flip.?flop|make up your mind|stick with|follow through|honor your|keep your promise|not fully committed|(are|aren't|are not) you committed|if you (are not|aren't) (all in|fully|100%)|believes in the (vision|mission|project)|commit (fully|completely|100)|no half measures|all in or (all out|nothing))\b/gi, principle: 'Commitment/Consistency', engine: 'PERSUASION', sev: 'medium', decode: 'Locking you into escalating commitments by referencing prior agreement.', legal: 'Contracts signed under pressure or without adequate review time may be voidable.' },

            // === EMOTIONAL ENGINE ===
            guilt: { re: /\b(disappointed|after everything|sacrificed|how you repay|meant something|ungrateful|selfish|(don't|do not) care|ashamed|your fault|blame yourself|if you (really )?loved me|gave up everything|I guess (I'm|I|my)|not (good|important) enough|you (don't|do not) (appreciate|value|care|respect)|throwing it away|slap in the face|how could you|I (can't|cannot) believe you|(you're|you are) breaking my|tearing this family|all I've done|is this how you|so much for|thanks for nothing|way to show|nice to know where I stand|clearly I (don't|do not) matter|I thought (we|I|you)|you used to|what happened to us|you've changed|not the person I|(do not|don't) (abandon|leave|give up on) me|only (thing|person) keeping me (going|alive|sane)|what (will|would) I do without you|(do not|don't) know what I (will|would) do|I (cannot|can't) (go on|do this|live|survive|make it) without you|I only (raised|supported|helped|cared for) you|everyone is making sacrifices|making sacrifices|we all (sacrifice|have to|need to)|have a better life|everything I (did|do) (was|is) for you)\b/gi, engine: 'EMOTIONAL', name: 'Guilt-Tripping', sev: 'high', decode: 'Weaponizing guilt to control your behavior and override your boundaries.', legal: 'Systematic guilt-tripping in workplace contexts may constitute emotional harassment.' },
            fear: { re: /\b(URGENT|(you'd|you would) be crazy|miss this|before (this|it) gets|taken down|too late|never again|last warning|consequences|fired|lose|threat|risk everything|permanently deleted|account.{0,20}compromised|regret|(don't|do not) want to regret|going FAST|at risk|be frozen|on your own|do not ignore|final notice|(we're|we are) filing|lawsuit|proceed|irreversible|permanent|point of no return|damage is done|window is closing|clock is ticking|(you'll|you will) wish you|(can't|cannot) undo|no turning back|there will be consequences|I (wouldn't|would not) want to be|watch what happens|be careful|tread lightly|think very carefully|you (don't|do not) want to|(wouldn't|would not) want anything to|for your own (good|sake|safety))\b/gi, engine: 'EMOTIONAL', name: 'Fear Induction', sev: 'high', decode: 'Triggering your fight-or-flight response to prevent rational evaluation.', legal: 'Threats, even veiled ones, may constitute coercion or duress, potentially voiding agreements.' },
            love_bomb: { re: /\b(never felt this way|only person who understands|soulmate|destiny|meant to be|(can't|cannot) live without|obsessed with you|you complete me|love at first|skip your friend|(you're|you are) different|just met|known you forever|planned something special|already know each other|have a feeling about|never opened up|skip the (small talk|games)|connection is different|I have a feeling|(you're|you are) my person|twin flame|universe brought us|stars aligned|I've been looking for someone like you|where have you been all my|you make me want to be|I've never (told anyone|shared this|opened up|been this|felt so)|I trust you more than|with you (it's|it is) different|I feel (safe|complete|whole|alive) with you|you understand me like no one|I could talk to you forever|(cannot|can not) stop thinking about you|you are the only (one|person)|I need you in my life|no one (has ever|ever) made me feel|when you know you know)\b/gi, engine: 'EMOTIONAL', name: 'Love Bombing', sev: 'high', decode: 'Overwhelming affection designed to create emotional dependency quickly.', legal: 'Love bombing is a recognized precursor to domestic abuse and coercive control.' },
            gaslighting: { re: /\b(I never said|that never happened|(you're|you are) (imagining|overreacting|too sensitive|being dramatic|crazy|paranoid|delusional|insecure|jealous|reading into|confused|mistaken|misremembering)|that (didn't|did not) happen|(I'm|I am) not angry|just (disappointed|saying|asking)|(we're|we are) a family here|keep bringing up|I thought you were|not looking for anything serious|you knew what this was|(that's|that is) not what I meant|I (didn't|did not) say that|(you're|you are) (making|blowing) (this|it|things) (up|out of proportion)|calm down|relax|chill|it was just a joke|(can't|cannot) you take a joke|(you're|you are) being (irrational|emotional|hysterical|ridiculous)|stop making everything about you|nobody else has a problem|you always do this|there you go again|why do you always|(you're|you are) twisting my words|(that's|that is) not how it went|you must have misunderstood|you always misremember|I think you need help|you have issues|maybe you should see someone|everyone thinks you're|people are worried about you|sacrifices (need|have) to be made|team player|not a (good|right) (fit|culture fit)|this is how (we do things|it works) here|get with the program|adapt or)\b/gi, engine: 'EMOTIONAL', name: 'Gaslighting', sev: 'high', decode: 'Redefining reality to make you doubt your own perception and judgment.', legal: 'Gaslighting in relationships is recognized as psychological abuse in many jurisdictions.' },
            future_faking: { re: /\b(equity will be worth|millionaire|5x|10x|guaranteed returns|by tomorrow|going to revolutionize|change your life|changing (their|your) lives?|retirement|financial freedom|I('ve| have) changed|get in early|your chance to|soon (I'll|we'll|things will|it will|everything will)|once (I|we|this) (make it|succeed|get there|get rich|get promoted)|when (I|we) (get|have|make|finish).{0,20}(everything|promise|you'll see|trust me)|next (month|year|time) (I promise|things will|it will|we will|everything will|you'll see)|I promise (I'll|things will|it will)|(it's|it is) going to be (different|better|amazing)|just wait (until|and see|till)|trust the process|big things coming|the best is yet to come|(I'm|I am) working on (myself|it|things|us)|give me (time|a chance|one more)|things are about to|on the verge of|almost there|so close to|your life is about to (change|transform)|life.?changing|this will change everything)\b/gi, engine: 'EMOTIONAL', name: 'Future Faking', sev: 'high', decode: 'Painting an unrealistic future to exploit present decision-making.', legal: 'Promises of guaranteed returns violate securities regulations in most jurisdictions.' },
            passive_aggression: { re: /\b((don't|do not) worry about me|I('ll| will) (just |be )?(sit here|fine|manage|stay home|clean up|wait|go to bed|deal with it)|I guess|used to being|(I'm|I am) used to|no one (ever|cares)|go enjoy yourself|have fun without me|I'll survive|not trying hard enough|of course (that's|that is) fine|ruining the vibe|I thought you were chill|kind of ruining|if (you're|you are) gonna keep|(you're|you are) (being|making this|making it) (weird|awkward|difficult)|whatever you say|if (that's|that is) what you think|sure (fine|whatever|okay)|good for you|must be nice|wish I could|some of us|not all of us|at least (I|some people)|(I'm|I am) just saying|no offense but|just an observation|I mean you do you|clearly you've made up your mind|I would(n't| not) (do|say|have done) (that|it|this|things) (that way|like that|but)|lol okay|interesting choice|bold move|(you're|you are) so (brave|confident) for|(that's|that is) one way to|oh interesting|I see|noted|okay then|well then|suit yourself|your (choice|call|loss|problem)|do whatever you want|you always do (anyway|what you want)|but sure|what do I know|(I am|I'm) just your (mother|father|parent|friend)|no (no )?it is fine|no (it is|it's) (fine|okay|cool|whatever)|totally fine|yeah (totally|completely|absolutely) fine|I (did not|didn't) (want|need|care) to go (anyway|anyhow)|it is not like|have fun with your (friends|family|buddies)|you go (and )?have fun|not like (we|I|it) (had|have|matter)|or anything)\b/gi, engine: 'EMOTIONAL', name: 'Passive Aggression', sev: 'medium', decode: 'Expressing hostility through veiled victimhood - designed to make you feel guilty without a direct accusation.', legal: 'Chronic passive-aggressive behavior in workplaces may contribute to a hostile work environment claim.' },
            emotional_overwhelm: { re: /\b(could save|will change|transform|you need to see|must (read|watch|know)|cannot ignore|life-changing|mind-blowing|earth-shattering|once.in.a.lifetime|never been done|revolutionary|groundbreaking|game.?changer|paradigm shift|world.?changing|history.?making|unprecedented|unbelievable|jaw.?dropping)\b/gi, engine: 'EMOTIONAL', name: 'Emotional Overwhelm', sev: 'medium', decode: 'Escalating the emotional stakes to prevent you from pausing and evaluating calmly.', legal: 'Exaggerated claims of impact may constitute deceptive advertising in commercial contexts.' },
            silent_treatment: { re: /\b(I (need|want) (space|time|some time)|I (can't|cannot) (talk|do this) right now|leaving you on read|not (ready|going) to (talk|discuss|engage)|when (I'm|I am) ready|(don't|do not) (contact|call|text|message) me|I'll (reach out|come to you|let you know) when|talk to the hand|(don't|do not) bother|blocked|muted)\b/gi, engine: 'EMOTIONAL', name: 'Silent Treatment', sev: 'medium', decode: 'Withdrawing communication as punishment to create anxiety and force compliance.', legal: 'Persistent stonewalling in professional settings may constitute constructive dismissal.' },
            triangulation: { re: /\b(my (ex|friend|coworker|mom|dad|therapist) (says|thinks|agrees|told me)|everyone (else )?(agrees|thinks|says)|other people (have|are|would)|someone else (wants|is interested|would love)|I've been (talking|venting) to|people are (saying|talking|worried)|you should hear what|compared to (my ex|other|them|her|him)|at least (she|he|they) (would|does|did|can)|unlike you|wish you were more like)\b/gi, engine: 'EMOTIONAL', name: 'Triangulation', sev: 'high', decode: 'Bringing third parties into the dynamic to create jealousy, insecurity, or pressure.', legal: 'Triangulation in workplace settings can create a hostile environment and may be considered bullying.' },

            // === FLATTERY ENGINE ===
            flattery_excessive: { re: /\b((you're|you are) (so|really|truly|honestly|genuinely|incredibly|absolutely|literally) (smart|talented|brilliant|amazing|wonderful|beautiful|gorgeous|handsome|kind|generous|thoughtful|creative|inspiring|special|unique|gifted|wise|perceptive|insightful)|nobody (else )?(is like you|compares|comes close|can do what you|has your)|I've (always|never) (admired|respected|looked up to|been impressed by) (you|your)|you have (no idea|such|this) (how|what a) (special|talented|gifted|amazing)|the (best|greatest|most talented|smartest|most beautiful) (person|human|man|woman|professional|writer|artist|mind)|I (wish I|want to be|aspire to be) (like you|as good as you|half as)|your (work|content|writing|art|ideas|mind|talent|beauty) is (incredible|unmatched|next level|god.?tier|elite|outstanding|extraordinary|phenomenal)|telling (the|my|our) (CEO|boss|manager|director|VP) about you|putting your name forward|nobody else could (have|do)|phenomenal (work|job|effort|talent|person)|(you are|you're) (truly |really )?(the only|the one|irreplaceable|indispensable)|no one (else )?(can|could) (do|handle|manage) (this|it|what you)|one of the most (talented|brilliant|amazing|smart|creative|gifted|inspiring|beautiful) (people|persons|humans|minds)|so proud of (how far|what) you)\b/gi, engine: 'PERSUASION', name: 'Excessive Flattery', principle: 'Liking', sev: 'medium', decode: 'Over-the-top compliments designed to make you feel special and lower your guard. Real appreciation is specific; manipulation is sweeping.', legal: 'Excessive flattery is a recognized social engineering technique used in fraud and confidence schemes.' },
            backhanded_compliment: { re: /\b((you're|you are) (pretty |actually |surprisingly |so )?(good|smart|talented|articulate|well.?spoken|attractive|fit) (for|considering|given)|I (didn't|(wouldn't|would not) have) (expect|thought|guessed)|not (bad|what I expected)|better than (I thought|expected|most)|you (clean up|scrub up) (nice|well|good)|wow you actually|(I'm|I am) (surprised|impressed) you (could|can|did|managed)|who knew you|look at you|(didn't|did not) know you had it in you|you actually (pulled|did|managed|made)|not bad for|I would not have (expected|guessed|thought)|(you're|you are) (doing|handling) (this|it) (better|well) (for|considering))\b/gi, engine: 'EMOTIONAL', name: 'Backhanded Compliment', sev: 'medium', decode: 'A compliment wrapped in an insult - designed to undermine confidence while appearing supportive.', legal: 'Patterns of backhanded compliments in workplace settings may constitute microaggression or harassment.' },

            // === POWER ENGINE ===
            deadline: { re: /\b(by EOD|sign (by|now|today)|expires? (today|tomorrow|soon)|hours? left|\d+ hours|clock is ticking|today only|act (fast|now)|(don't|do not) wait|limited time|hold this spot|end of (week|day)|by (Friday|Monday|tomorrow|tonight)|immediately|right now|before (this|it) closes|(can't|cannot) hold|after tomorrow|closing (tonight|soon|today)|lock.{0,10}(in|now)|going fast|decision by|need.{0,10}(answer|decision)|DM back in|in the next \d+|respond (by|within|before)|answer me (now|today)|I need to know (now|today|by)|waiting for your (answer|decision|response)|how long do I have to wait|finalizing (today|tomorrow|this week|by)|offer tonight|put in your offer|decision (tonight|today|by tomorrow))\b/gi, engine: 'POWER', name: 'Deadline Pressure', sev: 'high', decode: 'Artificial time pressure to prevent you from seeking advice or alternatives.', legal: 'Pressured signing timelines may indicate unfair contract terms. Most jurisdictions allow cooling-off periods.' },
            info_asymmetry: { re: /\b((can't|cannot) (name|tell|reveal|disclose)|NDA|confidential|secret|between us|insider|private information|(don't|do not) tell|off the record|I (shouldn't|should not) be telling you|keep this between|you (didn't|did not) hear this from me|I could get in trouble for|this is privileged|not supposed to share|(I'm|I am) risking|(don't|do not) share this|eyes only|classified)\b/gi, engine: 'POWER', name: 'Information Asymmetry', sev: 'medium', decode: 'Controlling what information you have access to in order to maintain power.', legal: 'Withholding material information in contractual negotiations may constitute fraud or misrepresentation.' },
            implicit_threat: { re: /\b(maybe (this|the) role|(isn't|is not) the right (fit|place|role|environment)|not the right (fit|place|role|environment) for you|maybe this (isn't|is not) (the right|for you|where you belong)|others would kill for|(people|candidates|applicants) who would (kill|love|die)|kill for your (spot|position|role|job|seat)|easily replaced|plenty of (people|candidates|others)|I could|think carefully|(wouldn't|would not) want to|reconsider|(can't|cannot) keep turning|someone (else|on the waitlist)|give your (spot|allocation)|before reviews|something to think about|just something to|(I'd|I would) hate (to|for) (see|have to|you to miss|you to lose|this to)|it would be a shame|I hope (it|this) doesn't|you might want to (reconsider|rethink|think about)|(I'm|I am) sure you (wouldn't|(don't|do not)) want|let's hope it doesn't come to|(I'd|I would) hate for (this|things) to|between you and (me|HR|management)|this could go (either|both) way|your (call|choice|decision|funeral)|others in your (position|place|shoes) would|most people would (jump|love|kill)|just want to make sure (you are|you're) (the right|a good)|make sure (this is|you are) (the right|a good) fit)\b/gi, engine: 'POWER', name: 'Implicit Threat', sev: 'high', decode: 'Veiled threats disguised as observations or suggestions.', legal: 'Implicit threats in employment contexts may constitute constructive dismissal or workplace intimidation.' },
            boundary_violation: { re: /\b(skip your|cancel your|drop everything|I (need|want) you to|you should|why (can't|cannot) you|just do it|is that too much|do this for me|I need you (here|now|today)|(you're|you are) (coming|doing it)|not (taking|accepting) no|this (isn't|is not) (optional|negotiable|a request)|I (don't|do not) care (what you|about your|if you)|your plans can wait|this is more important|rearrange your|make it work|figure it out|no excuses|I expect you to|you will|(you're|you are) going to|(only|the one) person I (trust|can count on|rely on|depend on)|figure it out (somehow|yourself)|make it happen|just (handle|deal with|take care of) it|I (would not|wouldn't) ask if (it|this) (was not|wasn't|were not|weren't) important|last minute but|I know (it is|it's|this is) (a lot|short notice|last minute))\b/gi, engine: 'POWER', name: 'Boundary Violation', sev: 'high', decode: 'Asking you to override your own plans, needs, or limits for their benefit.', legal: 'Persistent boundary violations in professional settings may establish a pattern of harassment.' },
            perpetual_rights: { re: /\b(perpetual|irrevocable|worldwide rights|all (work product|intellectual property|IP)|unlimited license|in perpetuity|exclusive(ly)? (rights|to us|license)|transfer of ownership|belongs exclusively|all industries|covering all)\b/gi, engine: 'POWER', name: 'Rights Grab', sev: 'high', decode: 'Claiming permanent, unrestricted ownership of your work.', legal: 'Perpetual, irrevocable rights clauses are considered onerous. Negotiate limited, purpose-specific licenses.' },
            non_compete: { re: /\b(non-?compete|non-?solicitation|restraint of trade|cannot work|restricted from|24 months? post|any related field)\b/gi, engine: 'POWER', name: 'Non-Compete Overreach', sev: 'high', decode: 'Broad non-compete clauses designed to limit your future career options.', legal: 'Many jurisdictions have banned or severely restricted non-compete agreements, especially for employees.' },
            forced_arbitration: { re: /\b(binding arbitration|waive (your )?right|class action waiver|our jurisdiction|sole discretion|dispute resolution|arbitrat)\b/gi, engine: 'POWER', name: 'Forced Arbitration', sev: 'high', decode: 'Removing your right to take legal action in court.', legal: 'Forced arbitration clauses may be unconscionable depending on jurisdiction. You may still have statutory rights.' },
            power_play: { re: /\b((I'm|I am) (the|your) (boss|manager|senior|lead|supervisor)|I (sign|approve|authorize) your|I decide (who|what|when|if)|this is my (call|decision|house|company)|under my (roof|watch|authority)|as long as (you live|(I'm|I am) paying|you work)|my (money|house|rules)|because I said so|end of discussion|(that's|that is) final|I (don't|do not) need to explain|take it or leave it|my way or)\b/gi, engine: 'POWER', name: 'Power Play', sev: 'high', decode: 'Using hierarchical position to shut down negotiation and assert dominance.', legal: 'Abuse of authority in employment may constitute workplace bullying or constructive dismissal.' },

            // === BIAS ENGINE ===
            anchoring: { re: /(\$[\d,]+[kKmMbB]?|\u20b9[\d,]+[kKlL]?|\b\d+[kK]\+?\b|\bwas \$|\bregular price\b|\bnormally\b|\boriginally\b|\bvalue of\b|\bworth \$|\bretail\b|\b\d+x\b|\bsix figures\b|\b\d+\s*crore|\b\d+\s*lakh|\bcompared to\b|\b(that's|that is) nothing compared|\bfor just\b|\bonly \$|\bfor the price of|\ba fraction of|\bpennies on the dollar|\bstealing? at this price)/gi, engine: 'BIAS', name: 'Anchoring', sev: 'medium', decode: 'Setting a high reference point to make the actual ask seem reasonable by comparison.', legal: 'Fictitious original prices in advertising are prohibited under most consumer protection statutes.' },
            framing: { re: /\b(not financial advice|(I'm|I am) not saying|just saying|just an observation|if you think about it|the truth is|what they (don't|do not) want|honestly|frankly|look,|let me be (real|honest|frank|straight)|between you and me|I'll be (honest|real|straight) with you|truth be told|to be (fair|honest)|in all (fairness|honesty)|with all due respect|no disrespect but|(don't|do not) take this the wrong way|I hate to say this but|I love you but|you know I (care|love you) but|I mean|I am just saying|just my opinion|just my (two cents|thought)|not that (it matters|you care|I mind|anyone asked)|if you ask me|all I am saying)\b/gi, engine: 'BIAS', name: 'Framing Effect', sev: 'low', decode: 'Packaging information in a way that steers your interpretation.', legal: 'Disclaimers that contradict the substance of a message may not provide legal protection.' },
            false_dilemma: { re: /\b(either|or else|only (two|2) (options|choices)|take it or leave|now or never|all or nothing|(you're|you are) (with us|against)|black and white|you (either|can either)|(it's|it is) (this|that) or (nothing|the highway)|(there's|there is) no (middle|in.?between|other)|pick a side|which is it|make up your mind|you (can't|cannot) have (it )?both|one or the other)\b/gi, engine: 'LOGIC', name: 'False Dilemma', sev: 'medium', decode: 'Presenting a complex situation as having only two options when more exist.', legal: 'False dilemmas in contract negotiations may indicate negotiation in bad faith.' },
            clickbait: { re: /\b(BREAKING|shocking|exposed|cover-?up|what they (don't|do not) want|hidden for|save your life|click now|before (this|it) gets taken down|industry doesn't|secret truth|what you (don't|do not) know|they (don't|do not) want you to|the media won't|mainstream media|censored|suppressed|wake up|sheep|red.?pill|open your eyes)\b/gi, engine: 'BIAS', name: 'Sensationalism', sev: 'high', decode: 'Extreme language designed to hijack your curiosity and bypass critical evaluation.', legal: 'Misleading headlines and sensationalist claims may violate advertising and content standards.' },
            curiosity_gap: { re: /\b(you (won't|will not) believe|the truth about|what (no one|nobody) tells|what happens next|the real reason|one weird trick|discover|shocking truth|doctors hate|number \d+ will|(you'll|you will) never guess|I (can't|cannot) believe|wait (till|until) you (see|hear)|what I found out|the secret to|what they're hiding|the thing about|here's (the thing|what no one)|most people (don't|do not) (know|realize))\b/gi, engine: 'BIAS', name: 'Curiosity Gap', sev: 'medium', decode: 'Creating an information gap that feels urgent to close.', legal: 'Content that uses curiosity gaps to drive clicks to misleading content may violate consumer protection standards.' },
            whataboutism: { re: /\b(what about (when you|the time you|your)|you (also|did the same|do it too)|at least I (don't|didn't|never)|(that's|that is) rich coming from|look who's talking|pot calling|(you're|you are) one to talk|and what about you|nice try but|let's talk about (you|your)|before you judge|clean your own|check yourself|glass house)\b/gi, engine: 'LOGIC', name: 'Whataboutism', sev: 'medium', decode: 'Redirecting blame or criticism back at you instead of addressing the actual issue.', legal: 'Deflection in legal proceedings can indicate consciousness of guilt or bad faith negotiation.' },
            toxic_positivity: { re: /\b(everything happens for a reason|the universe (is|has)|raise your (vibration|frequency|energy)|stay positive|positive vibes only|good vibes only|negative energy|blocking your (blessings|abundance|manifestation)|manifest|law of attraction|just (be|stay|think) (positive|grateful|happy)|choose (gratitude|happiness|joy)|surround myself with (people who|positive)|match my (frequency|energy|vibration)|your (energy|vibe|attitude) is (blocking|negative|toxic|bringing)|if you (just|would) (believe|trust the process|let go)|meant to be|not meant to be|the universe has a plan|everything (will|is going to) work out|toxic (people|energy|vibes))\b/gi, engine: 'EMOTIONAL', name: 'Toxic Positivity', sev: 'medium', decode: 'Dismissing legitimate emotions by enforcing relentless optimism. Invalidates real pain while positioning the speaker as spiritually superior.', legal: 'Toxic positivity in therapeutic or workplace settings can constitute emotional invalidation and professional negligence.' },
            weaponized_therapy: { re: /\b(I (need to |am going to )?(set|establish|enforce|hold) (a |my )?boundar(y|ies)|triggers? (my|your|their) (trauma|anxiety|response|responsibility)|your triggers|holding space|pour from an empty cup|(protect|protecting) (my|your) (peace|energy|space)|work on your (emotional|anger|self)|emotional (regulation|intelligence|labor)|you (need|should) (therapy|help|a therapist|to work on)|safe space|my (truth|lived experience)|doing the (work|inner work)|I (validate|hear|see) (you|your feelings) but|toxic (for me|to my|energy)|not my (responsibility|problem|job) to (manage|fix|heal|deal with) your)\b/gi, engine: 'EMOTIONAL', name: 'Weaponized Therapy Speak', sev: 'medium', decode: 'Using therapeutic language as a weapon to shut down legitimate concerns while maintaining moral high ground. Real boundaries do not come with ultimatums.', legal: 'Using psychological terminology to deflect legitimate grievances in professional settings may indicate bad faith communication.' },
            moving_goalposts: { re: /\b((that's|that is) not (what I meant|enough|the point)|I never said (that|exactly)|the real issue is|but what about|yes but|okay but (still|what about)|even (so|still|if)|that doesn't (matter|count|change)|beside the point|missing the point|(you're|you are) (missing|avoiding)|not the (point|issue|problem)|changing the|shifting|new (condition|requirement|standard))\b/gi, engine: 'LOGIC', name: 'Moving Goalposts', sev: 'medium', decode: 'Constantly shifting criteria so you can never meet expectations.', legal: 'Changing contract terms after agreement may constitute breach of contract or bad faith dealing.' },
        };

        // ========================
        // STRUCTURAL INDICATORS &mdash; Catch manipulation STRUCTURES, not just phrases
        // These detect multi-part patterns (setup + payoff) that PATTERNS miss
        // ========================
        const INDICATORS = {
            guilt_leverage: {
                re: /\b(I (did|gave|sacrificed|stayed|drove|helped|supported|spent|put up with|went through|sat by|was there|waited|held|nursed|took care|looked after|stood by|picked you up|covered for|lied for|fought for)|after (all|everything) (I|we)|for (you|this family|this relationship|us)|I('ve| have) (done|given|sacrificed|spent|been through))\b[\s\S]{0,80}\b(and (now|yet)|but you|can't even|won't even|don't even|this is (the thanks|how you)|you (can't|won't|don't)|is this how|so this is)\b/gi,
                score: 22, name: 'Guilt Leverage', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Setting up past sacrifices as ammunition to demand compliance now.',
                legal: 'Past voluntary actions do not create enforceable obligations.'
            },
            conditional_love: {
                re: /\b(if you (really|truly|actually) (loved|cared|wanted|appreciated|respected)|if you were a (real|true|good) (friend|partner|son|daughter|wife|husband|man|woman)|a real \w+ would)\b/gi,
                score: 18, name: 'Conditional Love', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Making love or approval contingent on compliance.',
                legal: 'Conditional affection is a recognized pattern in coercive control.'
            },
            passive_martyr: {
                re: /\b(it's (fine|okay|whatever)|no worries|don't worry about (me|it)|I'll (manage|survive|be (fine|okay|alright))|I'm used to (it|this|being))\b[\s\S]{0,60}\b(alone|by myself|without (you|anyone|help)|I guess|I suppose|as (usual|always)|like always|on my own|nobody|no one)\b/gi,
                score: 18, name: 'Passive Martyrdom', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Performing self-sacrifice to induce guilt without making a direct request.',
                legal: 'Passive-aggressive martyrdom in workplaces may constitute emotional manipulation.'
            },
            diminishment: {
                re: /\b(without me|nothing without|you'd be nothing|who (else|would) (put up with|deal with|want|bother with|tolerate)|good luck (finding|getting|with)|you'll (never find|regret|realize|see)|no one (else|will ever)|who else would)\b/gi,
                score: 22, name: 'Diminishment', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Destroying self-worth to create dependency.',
                legal: 'Systematic diminishment is a hallmark of coercive control in domestic abuse law.'
            },
            comparative: {
                re: /\b(your (brother|sister|mother|father|friend|friends|ex|cousin|coworker)|everyone else|other (people|couples|families)|normal people|my ex|unlike you)\b[\s\S]{0,50}\b(never|always|would|wouldn't|at least|manages to|makes time|doesn't|doesn't complain)\b/gi,
                score: 15, name: 'Unfair Comparison', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Using others as a weapon to make you feel inadequate.',
                legal: 'Persistent unfavorable comparisons in workplaces may constitute bullying.'
            },
            isolation: {
                re: /\b(you don't need (them|friends|anyone|anybody)|I'm (all|the only (one|person)) you need|they (don't|do not) (care|understand|know)|only I (understand|know|care|get)|no one (understands|knows|cares about) you like|I'm the (only|best) (thing|person))\b/gi,
                score: 22, name: 'Isolation Tactics', engine: 'POWER', sev: 'high',
                decode: 'Cutting off your support network to increase dependency.',
                legal: 'Isolation is a primary indicator of coercive control, criminalized in many jurisdictions.'
            },
            concern_wrap: {
                re: /\b(I (say|do|mention) this because|because I (love|care about) you|for your own (good|benefit|sake)|I'm (only|just) (trying to|looking out)|this (is|comes from) (a place of|out of) (love|concern)|I (wouldn't|won't) say this if I didn't care)\b/gi,
                score: 12, name: 'Concern-Wrapped Criticism', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Wrapping criticism in fake concern to make it unchallengeable.',
                legal: 'Concern-wrapping is a recognized manipulation technique in psychological literature.'
            },
            emotional_debt: {
                re: /\b(I've given (you|this)|all I('m| am) asking|one (small|little|simple) thing|is that (really|too much)|the (least|one thing) you (could|can)|all I (want|need|ask))\b/gi,
                score: 15, name: 'Emotional Debt', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Framing a request as a tiny repayment for massive (often inflated) sacrifices.',
                legal: 'Emotional debts have no legal standing.'
            },
            catastrophize: {
                re: /\b(you'll regret|rest of your life|things (will|are going to) get (bad|worse|ugly)|I'm warning you|mark my words|you'll (see|learn|realize)|come crawling back|one day you'll|going to (be sorry|regret this|wish))\b/gi,
                score: 15, name: 'Catastrophizing Threats', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Predicting doom to paralyze you with fear of future consequences.',
                legal: 'Veiled threats of future consequences may constitute intimidation.'
            },
            prosperity: {
                re: /\b(changed my life|from (my phone|anywhere)|passive income|financial freedom|my (mentor|coach)|this (system|method|blueprint|program)|making \$?\d+[kK]?\+? (a|per) (month|week|day|year)|six figures|results already|from the sidelines|be your own boss|work from (home|anywhere) .{0,30}(income|money|earn|make|passive|freedom|boss)|quit (my|your) (job|9.?to.?5)|my exact (method|system|blueprint|strategy)|DM me|link in bio)\b/gi,
                score: 15, name: 'Prosperity Pattern', engine: 'BIAS', sev: 'medium',
                decode: 'MLM/hustle culture language designed to sell a dream, not a product.',
                legal: 'Income claims without substantiation violate FTC guidelines.'
            },
            weaponized_vuln: {
                re: /\b(I (don't|do not) know what I'll do|can't (live|go on|survive|function) without|if you leave|please don't (go|leave|do this)|what (will|would) I do|I'll (die|break|fall apart)|I (need|can't live without) you)\b/gi,
                score: 18, name: 'Weaponized Vulnerability', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Using emotional fragility as a hostage situation.',
                legal: 'Threatening self-harm to control a partner is recognized as coercive control.'
            },
            stonewalling: {
                re: /\b(you (should|already) know|figure it out (yourself)?|I shouldn't have to (tell|explain|say)|not going to dignify|talk to me when you're (ready|reasonable|calm)|you know what you did|if you (don't|can't) (see|figure|understand))\b/gi,
                score: 15, name: 'Stonewalling', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Refusing to communicate as a punishment and power move.',
                legal: 'Stonewalling in professional mediation may indicate bad faith.'
            },
            sarcastic_obs: {
                re: /\b(I (just )?find it (funny|interesting|curious|telling|ironic)|it's (funny|interesting|telling) (how|that)|isn't it (funny|interesting|strange)|must be nice|oh,? (you|so you))\b/gi,
                score: 12, name: 'Sarcastic Deflection', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Using sarcasm to attack without being directly accountable.',
                legal: 'Persistent sarcastic undermining may contribute to hostile environment claims.'
            },
            monitoring: {
                re: /\b(give me your (phone|password|email|login)|went through your (phone|messages|email|diary|texts)|you've been (acting|being) (suspicious|different|weird|distant)|have nothing to hide|where (were|are) you|who (were|are) you (with|talking|texting)|let me see your (phone|messages))\b/gi,
                score: 18, name: 'Monitoring/Control', engine: 'POWER', sev: 'high',
                decode: 'Surveillance disguised as concern &mdash; a hallmark of controlling behavior.',
                legal: 'Unauthorized access to devices or accounts may violate computer fraud and privacy laws.'
            },
            universalize: {
                re: /\b(everyone (thinks|knows|says|agrees|can see)|nobody (else|thinks|has|would)|no one (else|agrees|has|would|complains)|you're the only (one|person) (who|that)|am I the only one|anyone (else|can see))\b/gi,
                score: 15, name: 'False Universalizing', engine: 'LOGIC', sev: 'medium',
                decode: 'Claiming everyone agrees with them to make you feel like the outlier.',
                legal: 'False consensus claims may constitute manipulation in negotiation contexts.'
            },
            abandonment_threat: {
                re: /\b(leave like everyone else|people always leave|go ahead (and|,) leave|see if I care|you'll be (sorry|alone)|don't come (crawling|running) back|this is your (last|final) chance|done with (you|this|us)|walking away|through with you)\b/gi,
                score: 18, name: 'Abandonment Threat', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Threatening to leave as a control mechanism.',
                legal: 'Abandonment threats in domestic settings are indicators of coercive control.'
            },
            victim_blame: {
                re: /\b(you (made|forced|drove|pushed) me|if you hadn't|you provoked|you brought this on|it's your (own )?fault|you asked for (it|this)|what did you expect|you (knew|know) what (you were|this was))\b/gi,
                score: 18, name: 'Victim Blaming', engine: 'EMOTIONAL', sev: 'high',
                decode: 'Shifting responsibility for their actions onto you.',
                legal: 'Victim-blaming is legally irrelevant &mdash; abusers are responsible for their own actions.'
            },
            // === EVASIVE INDICATORS &mdash; catch natural-language manipulation ===
            memory_question: {
                re: /\b(are you sure (you|that's|that|this)|you (sure|certain) (about|that)|remembering (this|that|it) right|mixing up (some |the )?(details|facts|events|things)|misremember|that's not (even close|what happened|how it went|how I remember)|completely different (event|conversation|story)|two different conversations)\b/gi,
                score: 15, name: 'Memory Questioning', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Subtly questioning your memory to make you doubt your own experience.',
                legal: 'Persistent reality-denial is a recognized form of psychological abuse.'
            },
            emotion_dismiss: {
                re: /\b(worked up|take a breather|calm yourself|getting (upset|heated|emotional|worked up) (about|over)|worth (getting upset|being angry|stressing|worrying) (about|over)|step back (and|from)|deep breath|not (worth|that) (serious|big|important)|blown out of proportion|not that deep|not a big deal|is it really (that|worth|this))\b/gi,
                score: 12, name: 'Emotion Dismissal', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Minimizing your emotions to avoid addressing the real issue.',
                legal: 'Systematic emotional invalidation may constitute psychological abuse.'
            },
            soft_surveillance: {
                re: /\b(check in with me (before|when)|noticed you were (online|up|out|away|active)|where (did you go|have you been|were you)|saw you were (online|up|active|posting)|who (did you go|were you out|are you texting|was that)|just (want|need) to know where|just (checking|making sure) (you're|you are) (safe|okay|alright))\b/gi,
                score: 15, name: 'Soft Surveillance', engine: 'POWER', sev: 'medium',
                decode: 'Monitoring your movements and activity under the guise of care.',
                legal: 'Covert monitoring and tracking behaviors are hallmarks of coercive control.'
            },
            appearance_control: {
                re: /\b(are you (sure|really going to|going to) wear (that|this)|that (outfit|dress|shirt|look) is.{0,20}(bold|a lot|a choice|interesting|different)|you'd look (better|nicer|more|great) (in|with|if)|just want you to (look|feel) (your best|confident|good)|maybe (change|wear something|try something))\b/gi,
                score: 12, name: 'Appearance Control', engine: 'POWER', sev: 'medium',
                decode: 'Controlling what you wear or how you look, disguised as care.',
                legal: 'Controlling a partner\'s appearance is a recognized form of coercive control.'
            },
            implicit_punishment: {
                re: /\b(I'll (probably |just )?be (asleep|gone|out|busy|unavailable)|don't (expect|wait up for|bother)|I (might|may) not be (here|around|available|home|awake)|if you (go|do that|choose|leave|decide).{0,30}(I'll|I might|don't expect|I won't))\b/gi,
                score: 15, name: 'Implicit Punishment', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Signaling withdrawal or punishment for your choices without making a direct threat.',
                legal: 'Withdrawal as punishment is a recognized pattern of emotional abuse.'
            },
            rapid_intimacy: {
                re: /\b(never connected.{0,20}(like this|this (way|level|deep))|scares me how (well|much|deep)|can't (explain|describe) (this|it|what|the) (connection|feeling|bond)|feel like I've known you|already (feel|know|sense) (like|that)|everything (makes sense|fell into place|clicked)|pieces (fell|falling) into place|rare (connection|thing|bond)|I don't (usually|normally|ever) (feel|open up|share|connect) (like this|this way|this much))\b/gi,
                score: 15, name: 'Manufactured Intimacy', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Creating a false sense of deep connection to accelerate emotional dependency.',
                legal: 'Love bombing and rapid intimacy are recognized precursors to emotional abuse.'
            },
            contrast_guilt: {
                re: /\b(I (cleared|cancelled|rearranged|gave up|moved|changed|adjusted|freed up).{0,30}(but|and you|yet you|only for)|had time for (that|them|your friends|everything else) but not|worth it\. I (ended up|had to|was left)|interesting (that|how) you (had|found|have) time.{0,20}but not)\b/gi,
                score: 15, name: 'Contrast Guilt', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Highlighting what they did vs. what you didn\'t to induce guilt.',
                legal: 'Emotional debts created through voluntary sacrifice have no legal standing.'
            },
            veiled_threat: {
                re: /\b(I (remember|don't forget|keep track of) everything|just so you know|let's just say (they|it|people)|I (do )?(know|have) people (who|that)|people who('ve| have) (crossed|wronged|underestimated) me|this (could|might|may) (affect|impact|change)|would be (unfortunate|a shame|sad|too bad)|I'd hate for (one|this|a single).{0,30}(overshadow|ruin|affect|impact))\b/gi,
                score: 15, name: 'Veiled Threat', engine: 'POWER', sev: 'medium',
                decode: 'Making threats through implication rather than direct statement.',
                legal: 'Implied threats can constitute intimidation or coercion under criminal law.'
            },
            despair_signal: {
                re: /\b(haven't been (sleeping|eating|functioning|getting out|leaving)|stare at the (ceiling|wall|floor)|sat in the dark|what's (even )?the (point|reason|purpose)|breaking point|everything (feels|is) (empty|pointless|meaningless|dark)|since you (left|went|moved|said)|don't (see|know) (the point|why|what|how to))\b/gi,
                score: 15, name: 'Despair Signaling', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Describing emotional collapse to make you feel responsible for their suffering.',
                legal: 'Using self-harm signals to control a partner is recognized as coercive control.'
            },
            mindset_blame: {
                re: /\b(shift(ed)? your (mindset|perspective|attitude|thinking|energy)|stopped being a victim|accept the lesson|choose (to be|happiness|positivity|joy|your attitude)|your (mindset|attitude|energy|thinking) is (holding|keeping|what's)|if you (just|would just|simply) (change|shift|adjust|fix) (your|the way you)|it's (all )?about (your |how you )?perspective|victim (mentality|mindset|thinking))\b/gi,
                score: 12, name: 'Mindset Blame', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Blaming your circumstances on your mindset rather than addressing real problems.',
                legal: 'Attributing systemic issues to individual mindset may constitute victim-blaming.'
            },
            shutdown_dismiss: {
                re: /\b(this (decision|matter|issue) has (already |been )?been (made|decided|settled)|above (both of us|your pay grade|your level)|not (your|up for|open to|available for) (call|decision|discussion|debate)|I appreciate your (feedback|input|thoughts) but|that ship has sailed|it is what it is|nothing (you|we) can do (about|now)|water under the bridge)\b/gi,
                score: 12, name: 'Input Shutdown', engine: 'POWER', sev: 'medium',
                decode: 'Dismissing your input or concerns by claiming the matter is already resolved.',
                legal: 'Silencing dissent in workplaces may indicate suppression of protected activity.'
            },
            bad_influence: {
                re: /\b((your |those |these )?(friends|people|crowd|group|circle) (are|is) (a bad|not a good|negative|toxic|a terrible)|you're different (when|around|after|with)|bad influence (on you|for you)|they (bring|drag) (out|you down)|changed (since|after|when) you (started|began)|I (liked|preferred|miss) (you|the old you|who you were) (before|when|better))\b/gi,
                score: 15, name: 'Social Interference', engine: 'POWER', sev: 'medium',
                decode: 'Attacking your relationships to isolate you and increase dependency.',
                legal: 'Social isolation tactics are a primary indicator of coercive control.'
            },
            competence_attack: {
                re: /\b(do you even know how to|I('m| am) (starting|beginning) to wonder if you (can|know|even)|sometimes I feel like I'm the only (adult|one|person)|the only (adult|grown.?up|responsible one|one who)|have to (do|handle|manage|take care of) everything (myself|around here|by myself))\b/gi,
                score: 12, name: 'Competence Attack', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Undermining your confidence by questioning your basic competence.',
                legal: 'Persistent competence attacks may constitute emotional abuse or workplace bullying.'
            },
            disappointed_withdrawal: {
                re: /\b(guess I was wrong about you|clearly I was (wrong|the only one|mistaken)|thought (we had|you were|this was)|I was wrong (about|to trust|to believe)|my mistake for (thinking|believing|trusting)|should have known (better|you'd|you wouldn't)|I expected (more|better|too much) from you)\b/gi,
                score: 12, name: 'Disappointed Withdrawal', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Expressing disappointment as a way to punish and induce guilt.',
                legal: 'Withdrawal of approval as control is a recognized manipulation pattern.'
            },
            reciprocity_prime: {
                re: /\b(remember (that time|when I|how I)|you know (how much|what|all) I (did|do|gave|give)|just (thought|thinking|wanted to mention) (you should|before you say|before you)|I (was up|stayed up|stayed late|took time|took a day) .{0,30}(for you|to help you|your))\b/gi,
                score: 12, name: 'Reciprocity Priming', engine: 'PERSUASION', sev: 'medium',
                decode: 'Subtly reminding you of past favors right before asking for something.',
                legal: 'Priming reciprocity is a recognized influence technique with no legal obligation.'
            },
            love_but: {
                re: /\b(I (love|care about|adore) you,? but.{0,40}(exhausting|draining|hard|difficult|impossible|tiring|too much|overwhelming)|I (love|respect|admire) you.{0,10}but (sometimes|honestly|I))\b/gi,
                score: 12, name: 'Love-But Diminishment', engine: 'EMOTIONAL', sev: 'medium',
                decode: 'Using affection as a shield to deliver criticism or diminishment.',
                legal: 'Conditional affirmation paired with criticism is a recognized emotional manipulation tactic.'
            },
            anti_pitch: {
                re: /\b(I'm not (going to|gonna|trying to) (pitch|sell|pressure|convince) you|this isn't a (pitch|sales|marketing)|I know how (it|this) (sounds|looks)|not (trying|here) to sell|hear me out (before|just)|just (going to|gonna) share|the (numbers|results|data|facts) speak for themselves)\b/gi,
                score: 12, name: 'Anti-Pitch Framing', engine: 'BIAS', sev: 'medium',
                decode: 'Framing a pitch as "not a pitch" to lower your defenses.',
                legal: 'Pre-emptive objection handling is a recognized sales manipulation technique.'
            },
        };

        const FRAMEWORKS = {
            cialdini: { title: 'Cialdini\'s 6 Principles', text: 'Robert Cialdini identified 6 principles of persuasion: Scarcity, Authority, Social Proof, Reciprocity, Liking, and Commitment. Marketers and manipulators use these daily.' },
            system: { title: 'System 1 / System 2', text: 'Daniel Kahneman\'s dual-process theory: System 1 is fast, emotional, automatic. System 2 is slow, rational, deliberate. Manipulation targets System 1.' },
            triad: { title: 'Dark Triad', text: 'Three personality traits linked to manipulation: Machiavellianism (strategic scheming), Narcissism (grandiosity), Psychopathy (callous disregard). This isn\'t a diagnosis &mdash; it\'s a pattern check.' },
            laws: { title: '48 Laws of Power', text: 'Robert Greene\'s book on power dynamics. We detect which "laws" the sender appears to be using against you.' },
        };

        const PSYCHOLOGY_FACTS = [
            'The "sunk cost fallacy" makes us invest more in bad decisions just because we\'ve already invested time or money.',
            'Anchoring bias: the first number you hear becomes your reference point for everything after.',
            'The backfire effect: being told you\'re wrong can actually strengthen false beliefs.',
            'Reciprocity works instantly. Give something small, and people feel obligated to give back something big.',
            'Scarcity (real or fake) activates your amygdala&mdash;the fear center of your brain.',
            'Authority figures don\'t need credentials. Just confidence and a suit.',
            'Social proof (FOMO) overrides logic faster than any logical argument.',
            'Commitment/consistency: once you say "yes" to something small, you\'re more likely to say "yes" to something big.',
            'Gaslighting works because our brains prefer to trust a familiar liar than a logical stranger.',
            'Love bombing floods your dopamine system, making you chemically dependent on the attention.',
        ];

        const PRESETS = [
            { name: 'Tesla Offer', icon: '&#x26A1;', text: 'Hey, we\'re offering Tesla owners $50K to refer friends. Only 10 spots left in your area and they\'re going FAST. Lock yours in now before this closes. Can\'t hold it after tomorrow.' },
            { name: 'Crypto Pitch', icon: '&#x20BF;', text: 'Early access closing TONIGHT. This token is moving fast&mdash;early investors 5x\'d in 48 hours. We usually don\'t tell people about this but you\'re different. Wire NOW or miss life-changing wealth. Only 24 hours.' },
            { name: 'Job Offer', icon: '&#x1F4BC;', text: 'We want you on the team. The role is amazing&mdash;equity, flexibility, and you\'ll be learning from founders who sold their last company for $200M. But we need your decision by Friday. Someone else is interested too.' },
            { name: 'Relationship', icon: '&#x1F494;', text: 'I\'ve never felt this way before. You\'re the only person who gets me. We\'re meant to be together. I know we just met but I swear our connection is different. Let\'s skip the games and just be us.' },
            { name: 'MLM Pitch', icon: '&#x1F4CA;', text: 'You\'re perfect for this. Make $10K/month from home with zero experience. Everyone in my network is doing it and making serious money. I\'m only asking because I see potential in you&mdash;most people aren\'t cut out for this.' },
            { name: 'Influencer DM', icon: '&#x2B50;', text: 'Your content is FIRE. I run a brand and we only work with top creators. I\'m breaking my rules just for you. We usually need 100K followers but I see something special here. DM back in 24 hours to lock in your partnership.' },
            { name: 'Legal Threat', icon: '&#x2696;&#xFE0F;', text: 'You owe us money. If you don\'t wire $5,000 by tomorrow, we\'re filing a lawsuit. We have your IP address and full legal team. This is your final notice before we proceed. Do not ignore this.' },
            { name: 'Fake News', icon: '&#x1F4F0;', text: 'BREAKING: Banks are crashing. Government covered this up. Your account could be frozen. Share this to 10 people or you\'re on your own. They don\'t want you to see this. Act NOW.' },
            { name: 'Dating App', icon: '&#x1F498;', text: "You're literally the most interesting person on this app. I don't usually message first but something about your profile just spoke to me. I feel like we already know each other. Can we skip the small talk and meet this weekend? I have a feeling about us." },
            { name: 'Insta DM', icon: '&#x1F4F8;', text: "Hey love! I've been following your content and you have SUCH amazing energy. I run a wellness brand and I think you'd be the perfect ambassador. We usually only work with accounts over 100K but I'm making an exception for you. DM me back in the next 24 hours to lock in your spot!" },
            { name: 'WhatsApp Fwd', icon: '&#x1F4F1;', text: "BREAKING: Government just passed a secret law that affects YOUR bank account. They don't want you to know this. Forward to 10 people before this gets taken down. Your money is at risk. Share NOW before it's too late!!!" },
            { name: 'Situationship', icon: '&#x1FAE0;', text: "I mean I'm not looking for anything serious rn but like you're different you know? I've never opened up to someone like this before. But if you're gonna keep bringing up labels it's kind of ruining the vibe. I thought you were chill about this." },
        ];

        // ========================
        // ANALYSIS FUNCTIONS
        // ========================

        function detectContext(text) {
            const lower = text.toLowerCase();
            let contexts = [];

            if (/crypto|bitcoin|ethereum|token|blockchain|web3|defi|nft/i.test(text)) contexts.push('crypto');
            if (/buy|sell|invest|roi|returns|profit|growth|margin|trading/i.test(text)) contexts.push('sales');
            if (/contract|agreement|terms|liable|sue|legal|attorney|law/i.test(text)) contexts.push('legal');
            if (/love|miss|cute|beautiful|dating|relationship|together|feel/i.test(text)) contexts.push('dating');
            if (/job|hire|role|team|startup|founder|equity|ceo/i.test(text)) contexts.push('job');
            if (/urgent|breaking|secret|before.*taken down|hidden|cover/i.test(text)) contexts.push('scam');
            if (/click|share|forward|viral|trending|like|comment|subscribe/i.test(text)) contexts.push('clickbait');
            if (/product|service|price|offer|discount|promo|deal/i.test(text)) contexts.push('business');

            return contexts.length > 0 ? contexts : ['general'];
        }

        function analyzeKahneman(text) {
            let system1 = 0, system2 = 0;

            // System 1 triggers (emotional, fast)
            if (/feel|emotion|gut|instant|immediately|urgency|fear|love|excited/i.test(text)) system1 += 2;
            if (/deadline|limited|last chance|rare|exclusive/i.test(text)) system1 += 2;
            if (/URGENT|BREAKING|!{2,}|\*{2,}/i.test(text)) system1 += 3;

            // System 2 triggers (logical, slow)
            if (/research|data|study|analysis|evidence|explain|because|therefore/i.test(text)) system2 += 2;
            if (/\b(according to|research shows|data indicates|studies prove)\b/i.test(text)) system2 += 2;

            return { system1, system2, dominant: system1 > system2 ? 'System 1 (Fast)' : system2 > 0 ? 'System 2 (Slow)' : 'Neutral' };
        }

        function detectLaws(text) {
            const lawsFound = [];

            // 48 Laws patterns
            if (/never|outshine|master/i.test(text)) lawsFound.push('Law 1: Never Outshine the Master');
            if (/trust|friend|enemy|know who|inside|circle/i.test(text)) lawsFound.push('Law 4: Always Say Less Than Necessary');
            if (/reputation|image|appear|seem/i.test(text)) lawsFound.push('Law 6: Make People Want to Help You');
            if (/secret|exclusive|private|insider|special/i.test(text)) lawsFound.push('Law 13: When Asking for Help, Appeal to Self-Interest');
            if (/(use|exploit|take advantage|leverage)/i.test(text)) lawsFound.push('Law 15: Crush Your Enemy Totally');
            if (/(isolation|alone|separate|cut off)/i.test(text)) lawsFound.push('Law 36: Disdain Things You Cannot Have');

            return lawsFound;
        }

        function scoreDarkTriad(text) {
            let machiavellianism = 0, narcissism = 0, psychopathy = 0;

            // Machiavellianism (manipulation, deception, strategic)
            if (/(lie|deceive|manipulate|trick|scheme|strategic|calculated|advantage)/i.test(text)) machiavellianism += 2;
            if (/(fake|pretend|mask|hidden|real me)/i.test(text)) machiavellianism += 1;

            // Narcissism (grandiosity, need for admiration)
            if (/(special|unique|different|perfect|amazing|deserve|best|never felt)/i.test(text)) narcissism += 2;
            if (/(only|chosen|elite|exclusive|rare)/i.test(text)) narcissism += 1;

            // Psychopathy (lack of empathy, callous)
            if (/((don't|do not) care|not my problem|deserve it|tough luck|your fault)/i.test(text)) psychopathy += 2;
            if (/(threat|harm|risk|lose|consequences)/i.test(text)) psychopathy += 1;

            return { machiavellianism, narcissism, psychopathy };
        }

        function detectNeuro(text) {
            let triggers = [];

            // Dopamine (reward, novelty)
            if (/(limited|exclusive|rare|new|first|only|before.*gone)/i.test(text)) triggers.push({ neuro: 'Dopamine', desc: 'Novelty + scarcity = reward anticipation' });

            // Cortisol (stress, fear)
            if (/(urgent|deadline|late|consequence|lose|threat|regret)/i.test(text)) triggers.push({ neuro: 'Cortisol', desc: 'Fear + urgency = stress response' });

            // Oxytocin (bonding, trust)
            if (/(special|different|connection|feel|belong|only person)/i.test(text)) triggers.push({ neuro: 'Oxytocin', desc: 'False intimacy = trust response' });

            // Serotonin (status, social)
            if (/(everyone|most people|trending|popular|exclusive|elite)/i.test(text)) triggers.push({ neuro: 'Serotonin', desc: 'Social proof = status seeking' });

            return triggers;
        }

        function detectDistortions(text) {
            let distortions = [];

            if (/(always|never|everyone|nobody)/i.test(text)) distortions.push('All-or-Nothing Thinking');
            if (/(catastrophize|disaster|worst|horrible|ruined)/i.test(text)) distortions.push('Catastrophizing');
            if (/(should|must|have to|supposed to)/i.test(text)) distortions.push('Should Statements');
            if (/(mind reading|know what you're thinking|you think)/i.test(text)) distortions.push('Mind Reading');
            if (/(your fault|blame|responsible|caused)/i.test(text)) distortions.push('Personalization');

            return distortions;
        }

        function generateXRay(text, findings) {
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            const xrayItems = [];

            sentences.forEach((sentence, idx) => {
                const clean = sentence.trim();
                if (clean.length < 10) return;

                let decodedHints = [];
                Object.entries(PATTERNS).forEach(([key, pattern]) => {
                    if (pattern.re.test(clean)) {
                        decodedHints.push(pattern.decode);
                    }
                });

                if (decodedHints.length > 0) {
                    xrayItems.push({
                        original: clean,
                        decoded: decodedHints[0]
                    });
                }
            });

            return xrayItems.slice(0, 5);
        }

        function generateVibe(findings, score) {
            const vibes = [
                { threshold: 75, vibe: 'Extremely manipulative. Multiple high-severity tactics layered.', tone: 'danger' },
                { threshold: 33, vibe: 'Highly manipulative. Clear intent to influence or pressure.', tone: 'danger' },
                { threshold: 20, vibe: 'Moderately manipulative. Some persuasion tactics present.', tone: 'warning' },
                { threshold: 10, vibe: 'Slightly manipulative. Minor influence attempts.', tone: 'warning' },
                { threshold: 0, vibe: 'Authentic and straightforward. No red flags detected.', tone: 'success' },
            ];

            return vibes.find(v => score >= v.threshold);
        }

        function generateResponse(text, findings, context) {
            if (mirrorMode && findings.patterns_found.length > 0) {
                return [
                    'Try being direct about what you want instead of using persuasion tactics.',
                    'Remove urgency language - if your request is reasonable, it does not need a deadline.',
                    'Replace flattery with specific, genuine appreciation.',
                ];
            }
            const responses = {
                sales: [
                    'Ask for written clarification on any claims. Request case studies or references.',
                    'Sleep on it. Any legitimate offer survives 24-48 hours without pressure.',
                    'Check the fine print. The real terms hide the manipulation.',
                ],
                dating: [
                    'Slow down. Authentic connection grows over weeks and months, not hours.',
                    'Trust your gut. If it feels rushed, it\'s because they\'re rushing it.',
                    'Spend time in groups. See how they act around others.',
                ],
                legal: [
                    'Get a lawyer before responding. Seriously.',
                    'Verify the claim independently. Call the organization directly.',
                    'Don\'t sign anything under time pressure.',
                ],
                job: [
                    'Negotiate timeline. No legitimate offer disappears in 48 hours.',
                    'Ask for written details. Vague promises are red flags.',
                    'Talk to current/former employees. Culture matters more than equity.',
                ],
                crypto: [
                    'If it guarantees returns, it\'s a scam. Full stop.',
                    'Any "insider" info offered freely is not insider info.',
                    'Assume you\'ll lose all the money you invest. Only put in what you can.',
                ],
            };

            const ctx = context[0] || 'general';
            return responses[ctx] || [
                'Ask clarifying questions. Manipulators hate follow-ups.',
                'Verify independently. Don\'t trust their sources.',
                'Sleep on it. Good decisions don\'t evaporate overnight.',
            ];
        }

        function generateLegalNotes(text, findings, context) {
            const notes = [];

            if (findings.high_severity.length > 0) {
                notes.push('This message contains patterns that may be legally actionable depending on context and jurisdiction.');
            }

            if (/threat|sue|legal|law|arrest/i.test(text)) {
                notes.push('If threatened, save all messages and consider consulting a lawyer.');
            }

            if (/guaranteed returns|sure profit|money guaranteed/i.test(text)) {
                notes.push('Promises of guaranteed returns violate securities law in most jurisdictions.');
            }

            if (/you owe|must pay|immediate payment/i.test(text)) {
                notes.push('Verify any debt claims independently. Many "debt collectors" are scams.');
            }

            return notes;
        }

        function analyze(text) {
            if (!text.trim()) return null;

            const findings = {
                patterns_found: [],
                high_severity: [],
                medium_severity: [],
                low_severity: [],
            };

            // Detect PATTERNS (phrase-level)
            Object.entries(PATTERNS).forEach(([key, pattern]) => {
                const matches = text.match(pattern.re);
                if (matches && matches.length > 0) {
                    findings.patterns_found.push({
                        key,
                        name: pattern.name || pattern.principle,
                        principle: pattern.principle,
                        engine: pattern.engine,
                        count: matches.length,
                        decode: pattern.decode,
                        legal: pattern.legal,
                        severity: pattern.sev,
                        source: 'pattern',
                    });

                    if (pattern.sev === 'high') findings.high_severity.push(key);
                    else if (pattern.sev === 'medium') findings.medium_severity.push(key);
                    else findings.low_severity.push(key);
                }
            });

            // Detect INDICATORS (structural multi-part patterns)
            Object.entries(INDICATORS).forEach(([key, ind]) => {
                const matches = text.match(ind.re);
                if (matches && matches.length > 0) {
                    // Avoid duplicate if a PATTERN already caught the same engine+name
                    const isDup = findings.patterns_found.some(p => p.key === key || (p.name === ind.name && p.engine === ind.engine));
                    if (!isDup) {
                        findings.patterns_found.push({
                            key: 'ind_' + key,
                            name: ind.name,
                            principle: ind.name,
                            engine: ind.engine,
                            count: matches.length,
                            decode: ind.decode,
                            legal: ind.legal,
                            severity: ind.sev,
                            source: 'indicator',
                        });
                        if (ind.sev === 'high') findings.high_severity.push('ind_' + key);
                        else if (ind.sev === 'medium') findings.medium_severity.push('ind_' + key);
                        else findings.low_severity.push('ind_' + key);
                    }
                }
            });

            // ========================
            // SCORING v2 &mdash; Redesigned for accuracy
            // Old formula: high=18, med=12, low=5 &#x2192; 1 high pattern = 18pts (rated "low")
            // New formula: high=30, med=20, low=10 &#x2192; 1 high pattern = 30pts (rated "medium")
            // Thresholds: 0-19 = low, 20-44 = medium, 45+ = high
            // ========================
            let score = 0;
            findings.patterns_found.forEach(p => {
                // Base score per severity
                const sevScore = p.severity === 'high' ? 30 : p.severity === 'medium' ? 20 : 10;
                score += sevScore;
                // Density bonus: repeated matches within one pattern
                if (p.count >= 5) score += 15;
                else if (p.count >= 4) score += 10;
                else if (p.count >= 3) score += 6;
                else if (p.count >= 2) score += 3;
                // Indicator bonus: structural patterns are higher-signal
                if (p.source === 'indicator') score += 5;
            });
            // Combo bonuses
            const engines = new Set(findings.patterns_found.map(f => f.engine));
            if (engines.size >= 3) score += 15;
            else if (engines.size >= 2) score += 8;
            if (findings.high_severity.length >= 3) score += 12;
            else if (findings.high_severity.length >= 2) score += 6;
            if (findings.patterns_found.length >= 5) score += 10;
            else if (findings.patterns_found.length >= 3) score += 5;
            score = Math.min(score, 100);
            // If nothing detected at all, assign a low baseline
            if (findings.patterns_found.length === 0) {
                let h = 0;
                for (let i = 0; i < text.length; i++) { h = ((h << 5) - h) + text.charCodeAt(i); h |= 0; }
                score = 3 + (Math.abs(h) % 8);
            }

            // Add analysis layers
            const context = detectContext(text);
            const kahneman = analyzeKahneman(text);
            const darkTriad = scoreDarkTriad(text);
            const laws = detectLaws(text);
            const neuro = detectNeuro(text);
            const distortions = detectDistortions(text);
            const xray = generateXRay(text, findings);
            const vibe = generateVibe(findings, score);
            const responses = generateResponse(text, findings, context);
            const legalNotes = generateLegalNotes(text, findings, context);

            return {
                score,
                vibe,
                context,
                findings,
                kahneman,
                darkTriad,
                laws,
                neuro,
                distortions,
                xray,
                responses,
                legalNotes,
                fact: PSYCHOLOGY_FACTS[Math.floor(Math.random() * PSYCHOLOGY_FACTS.length)],
            };
        }

        // ========================
        // UI INITIALIZATION
        // ========================

        function initializeUI() {
            initializePresets();
            initializeParticles();
            checkOnboarding();
            loadLevel();
            loadTheme();
            setupEventListeners();
        }

        function initializePresets() {
            const grid = document.getElementById('presetsGrid');
            PRESETS.forEach(preset => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.innerHTML = `<div class="preset-icon">${preset.icon}</div>${preset.name}`;
                btn.onclick = () => {
                    document.getElementById('messageInput').value = preset.text;
                    document.getElementById('messageInput').focus();
                };
                grid.appendChild(btn);
            });
        }

        function initializeRating() {
            const group = document.getElementById('ratingGroup');
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'star-btn';
                btn.innerHTML = '&#x2605;';
                btn.dataset.rating = i;
                btn.onclick = () => {
                    document.querySelectorAll('.star-btn').forEach(b => b.classList.remove('active'));
                    for (let j = 1; j <= i; j++) {
                        document.querySelector(`[data-rating="${j}"]`).classList.add('active');
                    }
                };
                group.appendChild(btn);
            }
        }

        function initializeParticles() {
            const bg = document.getElementById('particleBg');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                bg.appendChild(particle);
            }
        }

        function checkOnboarding() {
            if (!localStorage.getItem('hasVisited')) {
                document.getElementById('onboardingOverlay').classList.add('show');
                localStorage.setItem('hasVisited', 'true');
                // Tour starts AFTER onboarding is dismissed (see skipOnboarding)
            } else {
                // Only start tour if onboarding was already seen
                startOnboardingTour();
            }
        }

        function setupEventListeners() {
            document.getElementById('analyzeBtn').onclick = analyzeMessage;
            document.getElementById('clearBtn').onclick = () => {
                document.getElementById('messageInput').value = '';
                document.getElementById('resultsContainer').classList.remove('show');
                // Clear ALL tab content to prevent stale data
                document.querySelectorAll('.tab-content').forEach(t => t.innerHTML = '');
                document.getElementById('scoreSection').innerHTML = '';
                document.getElementById('shareSection').innerHTML = '';
                // Reset rephrase output
                const ro = document.getElementById('rephraseOutput');
                if (ro) { ro.style.display = 'none'; ro.innerHTML = ''; }
                const ri = document.getElementById('rephraseInput');
                if (ri) ri.value = '';
                if (typeof clearUpload === 'function') clearUpload();
                document.getElementById('realtimeBarFill').style.width = '0%';
                document.getElementById('realtimeHint').textContent = '';
                window.__lastResult = null;
                window.currentAnalysis = null;
            };

            // Rephrase mode uses onclick in HTML

            document.getElementById('historyBtn').onclick = showHistory;
        }

        function analyzeMessage() {
            const text = document.getElementById('messageInput').value;
            // Clear previous results before new analysis
            document.querySelectorAll('.tab-content').forEach(t => t.innerHTML = '');
            const result = analyze(text);

            if (!result) {
                showToast('Paste a message to analyze');
                return;
            }

            playScanSound();
            saveToHistory(text, result.score);
            displayResults(result);
            updateLevel();
            setTimeout(() => playResultSound(result.score), 1800);
            showToast('Analysis complete!');
        }

        function displayResults(result) {
            const container = document.getElementById('resultsContainer');
            window.__lastResult = result; // store for share card

            // Score section &mdash; animated reveal
            const scoreSection = document.getElementById('scoreSection');
            const circumference = 2 * Math.PI * 62;
            const finalOffset = circumference - (result.score / 100) * circumference;

            scoreSection.innerHTML = `
                <div class="score-container" id="scoreAnimContainer">
                    <div class="score-ring-wrapper">
                        <svg class="score-ring" viewBox="0 0 140 140">
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color: var(--accent-purple); stop-opacity: 1" />
                                    <stop offset="100%" style="stop-color: var(--accent-cyan); stop-opacity: 1" />
                                </linearGradient>
                            </defs>
                            <circle class="score-ring-bg" cx="70" cy="70" r="62"></circle>
                            <circle class="score-ring-progress" id="scoreRingAnim" cx="70" cy="70" r="62" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference};"></circle>
                        </svg>
                        <div class="score-text">
                            <div class="score-number animating" id="scoreNumAnim">0</div>
                            <div class="score-label">Manipulation<br>Score</div>
                        </div>
                    </div>
                    <div class="score-info">
                        <div class="vibe-title">${result.vibe.vibe}</div>
                        <div class="vibe-text">${result.findings.patterns_found.length} manipulation patterns detected.</div>
                        <div class="fact-box">&#x1F4A1; ${result.fact}</div>
                        <button class="share-score-btn" onclick="generateScoreCard()" style="margin-top:1rem;">&#x1F4F8; Share Score Card</button>
                    </div>
                </div>
            `;

            // Animate score ring + number count-up
            requestAnimationFrame(() => {
                const ring = document.getElementById('scoreRingAnim');
                const numEl = document.getElementById('scoreNumAnim');
                if (ring) ring.style.strokeDashoffset = finalOffset;
                // Count-up animation
                let current = 0;
                const target = result.score;
                const duration = 1600;
                const start = performance.now();
                function countUp(now) {
                    const elapsed = now - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                    current = Math.round(eased * target);
                    if (numEl) numEl.textContent = current;
                    if (progress < 1) requestAnimationFrame(countUp);
                    else document.getElementById('scoreAnimContainer')?.classList.add('revealed');
                }
                requestAnimationFrame(countUp);
            });

            // Tabs
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = `
                <button class="tab-btn active" onclick="switchTab('xray', this)">
                    X-Ray
                    <div class="tab-subtitle">What they really meant</div>
                </button>
                <button class="tab-btn" onclick="switchTab('findings', this)">
                    Findings
                    <div class="tab-subtitle">Tactics detected</div>
                </button>
                <button class="tab-btn" onclick="switchTab('profile', this)">
                    Profile
                    <div class="tab-subtitle">Psychological breakdown</div>
                </button>
                <button class="tab-btn" onclick="switchTab('coach', this)">
                    Coach
                    <div class="tab-subtitle">Your strategic response</div>
                </button>
            `;

            // X-Ray tab
            const xrayTab = document.getElementById('xrayTab');
            if (result.xray.length > 0) {
                xrayTab.innerHTML = `<div class="xray-list">` + result.xray.map(item => `
                    <div class="xray-item">
                        <div class="xray-original">
                            <div class="xray-label">${getMirrorLabels().said}</div>
                            <div class="xray-text">"${item.original}"</div>
                        </div>
                        <div>
                            <div class="xray-label">${getMirrorLabels().meant}</div>
                            <div class="xray-decode">${mirrorMode ? generateMirrorDecode(item) : item.decoded}</div>
                        </div>
                    </div>
                `).join('') + `</div>`;
            } else {
                xrayTab.innerHTML = '<p style="color: var(--fg-secondary); padding: 2rem;">No clear manipulation patterns in sentence-level analysis.</p>';
            }

            // Findings tab
            const findingsTab = document.getElementById('findingsTab');
            if (result.findings.patterns_found.length > 0) {
                findingsTab.innerHTML = `<div class="findings-grid">` + result.findings.patterns_found.map(f => `
                    <div class="finding-card">
                        <div class="finding-header">
                            <div class="finding-name">${f.name}</div>
                            <div class="finding-severity severity-${f.severity}">${f.severity}</div>
                        </div>
                        <div class="finding-principle tooltip-trigger" onclick="showFrameworkTooltip('${f.principle || f.engine}')">${f.principle || f.engine}</div>
                        <div class="finding-decode">${f.decode}</div>
                        <div class="finding-counter">${f.legal}</div>
                    </div>
                `).join('') + `</div>`;
            } else {
                findingsTab.innerHTML = '<p style="color: var(--fg-secondary); padding: 2rem;">No manipulation patterns detected!</p>';
            }

            // Psychological Profile tab
            const profileTab = document.getElementById('profileTab');
            const enginesUsed = {};
            result.findings.patterns_found.forEach(f => {
                enginesUsed[f.engine] = (enginesUsed[f.engine] || 0) + 1;
            });
            const dtScore = result.darkTriad;

            profileTab.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-item">
                        <div class="profile-label">Thinking System Targeted</div>
                        <div class="profile-value">${result.kahneman.dominant}</div>
                        <div class="profile-description">${result.kahneman.system1 > result.kahneman.system2 ? 'This message targets your fast, emotional brain - designed to get a reaction before you think.' : result.kahneman.system2 > 0 ? 'Uses logical-sounding arguments that may still contain hidden manipulation.' : 'Relatively neutral - no strong emotional or logical pressure detected.'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Dark Triad Signals</div>
                        <div class="profile-value" style="font-size:0.95rem;">
                            <span style="color:${dtScore.machiavellianism > 1 ? '#ff6b7a' : 'var(--fg-secondary)'}">Machiavelli: ${dtScore.machiavellianism}</span> |
                            <span style="color:${dtScore.narcissism > 1 ? '#ffb23a' : 'var(--fg-secondary)'}">Narcissism: ${dtScore.narcissism}</span> |
                            <span style="color:${dtScore.psychopathy > 1 ? '#ff6b7a' : 'var(--fg-secondary)'}">Psychopathy: ${dtScore.psychopathy}</span>
                        </div>
                        <div class="profile-description">This is a pattern check, not a diagnosis. Higher scores suggest more manipulative intent.</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Neurochemical Triggers</div>
                        <div class="profile-value" style="font-size:0.95rem;">${result.neuro.length > 0 ? result.neuro.map(n => n.neuro).join(' + ') : 'None detected'}</div>
                        <div class="profile-description">${result.neuro.length > 0 ? result.neuro.map(n => n.desc).join('. ') + '.' : 'No obvious neurochemical manipulation patterns found.'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">48 Laws of Power</div>
                        <div class="profile-value" style="font-size:0.85rem;">${result.laws.length > 0 ? result.laws.slice(0,3).join('<br>') : 'No specific laws detected'}</div>
                        <div class="profile-description">${result.laws.length > 0 ? 'The sender appears to be using these power dynamics.' : 'No Robert Greene power dynamics detected.'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Cognitive Distortions</div>
                        <div class="profile-value" style="font-size:0.95rem;">${result.distortions.length > 0 ? result.distortions.join(', ') : 'None detected'}</div>
                        <div class="profile-description">${result.distortions.length > 0 ? 'These thinking errors are present - they may be intentional manipulation or genuine cognitive bias.' : 'No cognitive distortions detected.'}</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Engine Breakdown</div>
                        <div class="profile-value" style="font-size:0.85rem;">${Object.entries(enginesUsed).map(([k,v]) => k + ': ' + v).join(' | ') || 'None'}</div>
                        <div class="profile-description">Shows which manipulation categories are most active in this message.</div>
                    </div>
                </div>
                ${result.legalNotes.length > 0 ? `
                <div style="margin-top:1.5rem;padding:1rem;background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.2);border-radius:8px;">
                    <strong style="color:var(--danger);">Legal Advisory</strong>
                    ${result.legalNotes.map(n => `<p style="color:var(--fg-secondary);margin-top:0.5rem;font-size:0.85rem;">- ${n}</p>`).join('')}
                </div>
                ` : ''}
            `;

            // Coach tab &mdash; mirror-mode aware
            const coachTab = document.getElementById('coachTab');
            if (mirrorMode && result.findings.patterns_found.length > 0) {
                const inputText = document.getElementById('messageInput').value;
                const rephrased = buildRephrase(inputText, result);
                const rephrasedResult = analyze(rephrased);
                coachTab.innerHTML = `
                <div class="coach-grid">
                    <div class="coach-item" style="grid-column: 1 / -1;">
                        <h4 style="color:#ff6b7a;">&#129694; What You Wrote (Score: ${result.score})</h4>
                        <p style="line-height:1.8;color:var(--fg-secondary);">${inputText.replace(/</g,'&lt;')}</p>
                    </div>
                    <div class="coach-item" style="grid-column: 1 / -1; border: 1px solid var(--success); background: rgba(46,213,115,0.05);">
                        <h4 style="color:var(--success);">&#10024; Cleaner Version (Score: ${rephrasedResult.score})</h4>
                        <p style="font-style:italic;line-height:1.8;margin-bottom:1rem;" id="mirrorRephrasedText">${rephrased.replace(/</g,'&lt;')}</p>
                        <button class="btn btn-secondary btn-small" onclick="navigator.clipboard.writeText(document.getElementById('mirrorRephrasedText').textContent);showToast('Copied!');">Copy Clean Version</button>
                    </div>
                    ${result.findings.patterns_found.map(f => '<div class="coach-item"><h4 style="color:#ffb23a;">&#9888;&#65039; ' + f.name + '</h4><p style="color:var(--fg-secondary);">This may come across as ' + f.name.toLowerCase() + '. Consider rephrasing to be more direct.</p></div>').join('')}
                </div>`;
            } else {
            const suggestedReply = generateSuggestedReply(result.context, result.findings);
            coachTab.innerHTML = `
                <div class="coach-grid">
                    ${result.responses.map((r, i) => `
                    <div class="coach-item">
                        <h4>Move ${i + 1}</h4>
                        <p>${r}</p>
                    </div>
                    `).join('')}
                    <div class="coach-item" style="grid-column: 1 / -1; border: 1px solid var(--accent-cyan); background: rgba(0,217,255,0.05);">
                        <h4 style="color:var(--accent-cyan);">&#x1F4AC; Suggested Response</h4>
                        <p style="font-style:italic;line-height:1.8;margin-bottom:1rem;">"${suggestedReply}"</p>
                        <button class="btn btn-secondary btn-small" onclick="navigator.clipboard.writeText('${suggestedReply.replace(/'/g, "\\'")}');showToast('Response copied!');">Copy Response</button>
                    </div>
                    ${result.legalNotes.length > 0 ? `
                    <div class="coach-item" style="grid-column: 1 / -1;">
                        <h4>Legal Context</h4>
                        <p>${result.legalNotes.map(n => '&#x2022; ' + n).join('<br>')}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            } // end mirror mode else

            // Share section
            document.getElementById('shareSection').innerHTML = `
                <div class="share-section">
                    <button class="share-btn" onclick="shareToWhatsApp()">WhatsApp</button>
                    <button class="share-btn" onclick="copyShareLink()">Copy Link</button>
                    <button class="share-btn" onclick="shareToTwitter()">Twitter/X</button>
                    <button class="share-btn" onclick="shareToLinkedIn()">LinkedIn</button>
                    <button class="share-btn" onclick="shareToInstagram()">Instagram</button>
                </div>
            `;

            container.classList.add('show');
            window.currentAnalysis = result;
        }

        function switchTab(tab, btnEl) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Use passed element reference instead of fragile event.target
            if (btnEl) {
                const btn = btnEl.closest ? btnEl.closest('.tab-btn') : btnEl;
                if (btn) btn.classList.add('active');
            }
            const tabEl = document.getElementById(tab + 'Tab');
            if (tabEl) tabEl.classList.add('active');
        }

        function showFrameworkTooltip(framework) {
            const tooltips = {
                'Scarcity': FRAMEWORKS.cialdini,
                'Authority': FRAMEWORKS.cialdini,
                'Social Proof': FRAMEWORKS.cialdini,
                'Reciprocity': FRAMEWORKS.cialdini,
                'Liking': FRAMEWORKS.cialdini,
                'Commitment/Consistency': FRAMEWORKS.cialdini,
            };

            const info = tooltips[framework];
            if (info) {
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = `<div class="tooltip-title">${info.title}</div><div class="tooltip-text">${info.text}</div>`;
                tooltip.classList.add('show');

                setTimeout(() => tooltip.classList.remove('show'), 5000);
            }
        }

        // === REPHRASE MODE ===
        let rephraseMode = false;
        function toggleRephraseMode() {
            rephraseMode = !rephraseMode;
            const div = document.getElementById('rephraseInputs');
            const toggle = document.getElementById('toggleSwitch');
            if (rephraseMode) {
                div.style.display = 'block';
                toggle.classList.add('active');
            } else {
                div.style.display = 'none';
                toggle.classList.remove('active');
                document.getElementById('rephraseOutput').style.display = 'none';
            }
        }

        function rephraseMessage() {
            const text = document.getElementById('rephraseInput').value;
            if (!text.trim()) { showToast('Paste a message to rephrase'); return; }

            const result = analyze(text);
            const output = document.getElementById('rephraseOutput');

            if (result.findings.patterns_found.length === 0) {
                output.style.display = 'block';
                output.innerHTML = `<div style="padding:1.5rem;background:rgba(46,213,115,0.1);border:1px solid rgba(46,213,115,0.3);border-radius:12px;"><h4 style="color:var(--success);margin-bottom:0.5rem;">Clean Message</h4><p style="color:var(--fg-secondary);">No manipulation patterns detected. Your message looks genuine and respectful.</p></div>`;
                return;
            }

            const rephrased = buildRephrase(text, result);
            const rephrasedResult = analyze(rephrased);

            output.style.display = 'block';
            output.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;">
                    <div style="padding:1.25rem;background:rgba(255,71,87,0.08);border:1px solid rgba(255,71,87,0.2);border-radius:12px;">
                        <h4 style="color:#ff6b7a;margin-bottom:0.75rem;">Your Original (Score: ${result.score})</h4>
                        <p style="color:var(--fg-secondary);line-height:1.7;font-size:0.95rem;">${text}</p>
                    </div>
                    <div style="padding:1.25rem;background:rgba(46,213,115,0.08);border:1px solid rgba(46,213,115,0.2);border-radius:12px;">
                        <h4 style="color:var(--success);margin-bottom:0.75rem;">Cleaner Version (Score: ${rephrasedResult.score})</h4>
                        <p style="color:var(--fg-secondary);line-height:1.7;font-size:0.95rem;" id="rephrasedText">${rephrased}</p>
                        <button class="btn btn-secondary btn-small" onclick="navigator.clipboard.writeText(document.getElementById('rephrasedText').textContent);showToast('Copied!')" style="margin-top:1rem;">Copy Clean Version</button>
                    </div>
                </div>
                <div style="padding:1rem;background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);border-radius:10px;">
                    <h4 style="color:var(--accent-purple);margin-bottom:0.75rem;">What was flagged</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                        ${result.findings.patterns_found.map(f => `<span style="padding:0.3rem 0.75rem;background:rgba(${f.severity==='high'?'255,71,87':f.severity==='medium'?'255,165,2':'46,213,115'},0.15);border-radius:6px;font-size:0.8rem;color:${f.severity==='high'?'#ff6b7a':f.severity==='medium'?'#ffb23a':'#6edd89'};">${f.name}</span>`).join('')}
                    </div>
                </div>
            `;
            playScanSound();
        }

        function buildRephrase(text, result) {
            if (!result.findings.patterns_found.length) return text;

            // Collect all pattern regexes that were detected
            const patternRegexes = [];
            result.findings.patterns_found.forEach(f => {
                if (PATTERNS[f.key] && PATTERNS[f.key].re) {
                    patternRegexes.push({
                        re: new RegExp(PATTERNS[f.key].re.source, 'gi'),
                        sev: PATTERNS[f.key].sev || 'medium'
                    });
                }
            });
            if (!patternRegexes.length) return text;

            // Split into sentences (preserve the delimiter)
            const sentences = text.match(/[^.!?]*[.!?]+|[^.!?]+$/g) || [text];
            const cleanSentences = [];

            sentences.forEach(sentence => {
                const trimmed = sentence.trim();
                if (!trimmed || trimmed.length < 3) return;

                // Check if any detected pattern matches this sentence
                let hasHighMatch = false;
                let hasLowMatch = false;
                patternRegexes.forEach(p => {
                    const freshRe = new RegExp(p.re.source, 'gi');
                    if (freshRe.test(trimmed)) {
                        if (p.sev === 'high' || p.sev === 'medium') {
                            hasHighMatch = true;
                        } else {
                            hasLowMatch = true;
                        }
                    }
                });

                if (hasHighMatch) {
                    // Sentence contains high/medium severity manipulation &#x2192; drop it
                    return;
                }
                // Low severity or no match &#x2192; keep sentence as-is
                cleanSentences.push(trimmed);
            });

            let clean = cleanSentences.join(' ').replace(/\s+/g, ' ').trim();

            // If nothing meaningful remains, use a neutral fallback
            if (clean.length < 25 || clean.split(/\s+/).length < 4) {
                clean = "I'd like to discuss this with you. Can we talk about it calmly and honestly?";
            }
            return clean;
        }



        function shareToWhatsApp() {
            if (window.currentAnalysis) {
                const text = `I just decoded this message with Human Filter. Manipulation Score: ${window.currentAnalysis.score}/100. Check it out!`;
                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url);
            }
        }

        function copyShareLink() {
            const text = `Manipulation Score: ${window.currentAnalysis.score}/100. Key patterns: ${window.currentAnalysis.findings.patterns_found.slice(0, 3).map(f => f.name).join(', ')}`;
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        function shareToTwitter() {
            if (window.currentAnalysis) {
                const text = `Just analyzed a message with @HumanFilter. Manipulation Score: ${window.currentAnalysis.score}/100. ${window.currentAnalysis.findings.patterns_found.length} tactics detected. You can decode too.`;
                const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                window.open(url);
            }
        }

        function shareToLinkedIn() {
            const url = 'https://aakarshsharma.com/human-filter-v9.html';
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`);
        }

        function shareToInstagram() {
            // Instagram doesn't have a direct share URL, so copy text for them
            if (window.currentAnalysis) {
                const text = `&#x1F50D; Manipulation Score: ${window.currentAnalysis.score}/100\n${window.currentAnalysis.findings.patterns_found.length} tactics detected.\n\nTry it: aakarshsharma.com/human-filter-v9.html\n\n#HumanFilter #ManipulationDetection #Psychology`;
                navigator.clipboard.writeText(text);
                showToast('Caption copied! Paste in Instagram.');
            }
        }

        function showLevelTooltip() {
            const tooltip = document.getElementById('levelTooltip');
            tooltip.classList.toggle('show');
            setTimeout(() => tooltip.classList.remove('show'), 4000);
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const status = document.getElementById('uploadStatus');
            const preview = document.getElementById('uploadPreview');

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // OCR
            status.textContent = 'Extracting text...';
            status.style.color = 'var(--accent-cyan)';

            try {
                const result = await Tesseract.recognize(file, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            status.textContent = `Extracting... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                const extractedText = result.data.text.trim();
                if (extractedText) {
                    document.getElementById('messageInput').value = extractedText;
                    status.textContent = `&#x2713; Extracted ${extractedText.split(' ').length} words`;
                    document.getElementById('uploadClearBtn').style.display = 'inline-block';
                    status.style.color = 'var(--success)';
                    showToast('Text extracted! Click Analyze.');
                } else {
                    status.textContent = 'No text found in image';
                    document.getElementById('uploadClearBtn').style.display = 'inline-block';
                    status.style.color = 'var(--warning)';
                }
            } catch (err) {
                status.textContent = 'OCR failed. Try a clearer image.';
                document.getElementById('uploadClearBtn').style.display = 'inline-block';
                status.style.color = 'var(--danger)';
            }
        }

        function clearUpload() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadClearBtn').style.display = 'none';
        }

        function generateSuggestedReply(context, findings) {
            const ctx = context[0] || 'general';
            const hasHighSeverity = findings.high_severity.length > 0;
            const patternNames = findings.patterns_found.map(p => p.key);

            const replies = {
                sales: hasHighSeverity
                    ? "Thanks for reaching out. I appreciate the offer, but I need to review this with my advisor before making any commitments. I'll get back to you within a week."
                    : "Interesting &mdash; can you send me the full details in writing? I like to review things carefully before committing.",
                dating: patternNames.includes('love_bomb')
                    ? "I appreciate the kind words, but I prefer to take things slow and get to know someone naturally. Let's keep chatting and see where it goes."
                    : "Thanks for the message! I'm open to chatting more, but I like to take my time getting to know people. No rush.",
                legal: "I've received your message. I'm forwarding this to my legal counsel for review. Please direct all further communication to them.",
                job: "Thank you for the opportunity. I'm interested, but I'll need at least a week to review the full offer details, speak with current team members, and make a thoughtful decision.",
                crypto: "I appreciate you sharing this, but I only invest after doing my own due diligence. I'll pass on this one.",
                scam: "I'm not going to engage with this. If this is legitimate, please provide verifiable credentials and I'll have my attorney review it.",
                clickbait: "I don't forward unverified information. If this is real, I'll wait for a credible news source to report on it.",
                general: hasHighSeverity
                    ? "I've noted what you said, but I need time to think about this. I don't make decisions under pressure, and I'd appreciate if you respect that."
                    : "Thanks for your message. Let me take some time to think this through and I'll get back to you."
            };

            // Also check context selector override
            const selectorCtx = document.getElementById('contextSelect')?.value;
            if (selectorCtx && selectorCtx !== 'auto') {
                const ctxMap = { boss:'job', date:'dating', family:'general', stranger:'scam',
                    sales:'sales', friend:'general', ex:'dating', social:'clickbait' };
                const mapped = ctxMap[selectorCtx] || 'general';
                return replies[mapped] || replies.general;
            }
            return replies[ctx] || replies.general;
        }

        // === SHARE SCORE CARD (Canvas PNG export) ===
        function generateScoreCard() {
            const r = window.__lastResult;
            if (!r) return showToast('Analyze a message first');
            const canvas = document.createElement('canvas');
            canvas.width = 600; canvas.height = 400;
            const ctx = canvas.getContext('2d');

            // Background gradient
            const bg = ctx.createLinearGradient(0, 0, 600, 400);
            bg.addColorStop(0, '#0f0f1e'); bg.addColorStop(1, '#1a1a3e');
            ctx.fillStyle = bg; ctx.fillRect(0, 0, 600, 400);

            // Border glow
            ctx.strokeStyle = 'rgba(0,217,255,0.3)'; ctx.lineWidth = 2;
            ctx.roundRect(10, 10, 580, 380, 16); ctx.stroke();

            // Title
            ctx.font = 'bold 20px "Space Grotesk", sans-serif';
            ctx.fillStyle = '#00d9ff'; ctx.fillText('THE HUMAN FILTER', 30, 50);
            ctx.font = '12px Inter, sans-serif';
            ctx.fillStyle = '#8892b0'; ctx.fillText('aakarshsharma.com/human-filter-v9.html', 30, 70);

            // Score circle
            const cx = 120, cy = 190, rad = 65;
            ctx.beginPath(); ctx.arc(cx, cy, rad, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(0,217,255,0.1)'; ctx.lineWidth = 8; ctx.stroke();
            // Score arc
            const startAngle = -Math.PI / 2;
            const endAngle = startAngle + (r.score / 100) * Math.PI * 2;
            const grad = ctx.createLinearGradient(cx-rad, cy-rad, cx+rad, cy+rad);
            grad.addColorStop(0, '#a855f7'); grad.addColorStop(1, '#00d9ff');
            ctx.beginPath(); ctx.arc(cx, cy, rad, startAngle, endAngle);
            ctx.strokeStyle = grad; ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.stroke();
            // Score number
            ctx.font = 'bold 40px "Space Grotesk", sans-serif';
            ctx.fillStyle = '#ffffff';
            const scoreStr = String(r.score);
            const sw = ctx.measureText(scoreStr).width;
            ctx.fillText(scoreStr, cx - sw/2, cy + 10);
            ctx.font = '11px Inter, sans-serif';
            ctx.fillStyle = '#8892b0';
            const label = 'Manipulation Score';
            const lw = ctx.measureText(label).width;
            ctx.fillText(label, cx - lw/2, cy + 30);

            // Verdict
            ctx.font = 'bold 16px "Space Grotesk", sans-serif';
            ctx.fillStyle = '#ffffff';
            const vibeLines = wrapText(ctx, r.vibe.vibe, 350);
            vibeLines.forEach((line, i) => ctx.fillText(line, 210, 140 + i * 22));

            // Top patterns
            ctx.font = '13px Inter, sans-serif';
            const topPatterns = r.findings.patterns_found.slice(0, 3);
            topPatterns.forEach((p, i) => {
                const y = 190 + i * 30;
                const sevColor = p.severity === 'high' ? '#ff6b7a' : p.severity === 'medium' ? '#ffb23a' : '#6edd89';
                ctx.fillStyle = sevColor;
                ctx.fillText('&#x25CF;', 210, y);
                ctx.fillStyle = '#ccd6f6';
                ctx.fillText(`${p.name} (${p.severity})`, 230, y);
            });

            // Footer
            ctx.font = '11px Inter, sans-serif';
            ctx.fillStyle = '#4a5568';
            ctx.fillText('Built by Aakarsh Sharma &middot; Law &#xD7; Psychology &#xD7; AI', 30, 370);
            ctx.fillText('Try it: aakarshsharma.com/human-filter-v9.html', 350, 370);

            // Share or Download
            const dataUrl = canvas.toDataURL('image/png');
            if (navigator.share && navigator.canShare) {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], 'human-filter-score.png', { type: 'image/png' });
                    try {
                        await navigator.share({ title: 'My Human Filter Score', text: 'Manipulation Score: ' + r.score + '/100', files: [file] });
                        showToast('Shared!');
                    } catch(e) {
                        const dl = document.createElement('a'); dl.download = 'human-filter-score-' + r.score + '.png'; dl.href = dataUrl; dl.click();
                        showToast('Score card saved!');
                    }
                }, 'image/png');
            } else {
                const dl = document.createElement('a'); dl.download = 'human-filter-score-' + r.score + '.png'; dl.href = dataUrl; dl.click();
                showToast('Score card saved! Share it on socials.');
            }
        }

        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = []; let line = '';
            words.forEach(word => {
                const test = line + word + ' ';
                if (ctx.measureText(test).width > maxWidth && line) {
                    lines.push(line.trim()); line = word + ' ';
                } else { line = test; }
            });
            if (line) lines.push(line.trim());
            return lines;
        }

        // === ONBOARDING TOUR ===
        function startOnboardingTour() {
            if (localStorage.getItem('tourCompleted')) return;
            const steps = [
                { target: '.context-selector', title: 'Set the Context', text: 'Tell us who sent the message &mdash; it makes the analysis and response suggestions way more accurate.', pos: 'bottom' },
                { target: '#messageInput', title: 'Paste Any Message', text: 'Drop in a text, email, DM, or WhatsApp forward. Or use Upload Screenshot for images.', pos: 'bottom' },
                { target: '.presets-grid', title: 'Or Try a Preset', text: 'Not sure what to test? Tap any preset to see the engine in action with real-world examples.', pos: 'bottom' },
                { target: '#levelBadge', title: 'Level Up!', text: 'Every scan earns XP. Keep scanning to unlock Aware, Decoder, and Master Filter levels.', pos: 'left' },
            ];
            let currentStep = 0;

            function showStep(i) {
                // Clean previous
                document.querySelectorAll('.tour-overlay,.tour-tooltip,.tour-highlight').forEach(el => el.remove());
                document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

                if (i >= steps.length) {
                    localStorage.setItem('tourCompleted', 'true');
                    showToast('You\'re all set! Start scanning.');
                    return;
                }

                const step = steps[i];
                const targetEl = document.querySelector(step.target);
                if (!targetEl) { showStep(i + 1); return; }

                // Overlay
                const overlay = document.createElement('div');
                overlay.className = 'tour-overlay';
                document.body.appendChild(overlay);

                // Highlight target
                targetEl.classList.add('tour-highlight');
                targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Tooltip
                setTimeout(() => {
                    const rect = targetEl.getBoundingClientRect();
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tour-tooltip';
                    tooltip.innerHTML = `
                        <div class="tour-step">Step ${i+1} of ${steps.length}</div>
                        <h4>${step.title}</h4>
                        <p>${step.text}</p>
                        <div class="tour-nav">
                            <button class="tour-btn tour-btn-skip" onclick="endTour()">Skip</button>
                            <button class="tour-btn tour-btn-next" onclick="nextTourStep()">${i === steps.length - 1 ? 'Got it!' : 'Next &#x2192;'}</button>
                        </div>
                    `;

                    // Position
                    if (step.pos === 'bottom') {
                        tooltip.style.top = (rect.bottom + 12) + 'px';
                        tooltip.style.left = Math.max(10, rect.left) + 'px';
                    } else {
                        tooltip.style.top = rect.top + 'px';
                        tooltip.style.right = (window.innerWidth - rect.left + 12) + 'px';
                    }
                    document.body.appendChild(tooltip);
                }, 400);

                currentStep = i;
            }

            window.nextTourStep = () => showStep(currentStep + 1);
            window.endTour = () => {
                document.querySelectorAll('.tour-overlay,.tour-tooltip').forEach(el => el.remove());
                document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
                localStorage.setItem('tourCompleted', 'true');
            };

            setTimeout(() => showStep(0), 800);
        }

        function saveToHistory(text, score) {
            let history = JSON.parse(localStorage.getItem('filterHistory') || '[]');
            history.unshift({
                text: text.substring(0, 50),
                score,
                timestamp: new Date().toLocaleString(),
                fullText: text,
            });
            history = history.slice(0, 20);
            localStorage.setItem('filterHistory', JSON.stringify(history));
        }

        function showHistory() {
            const history = JSON.parse(localStorage.getItem('filterHistory') || '[]');
            const historySection = document.getElementById('historySection');

            document.getElementById('resultsContainer').classList.add('show');
            if (history.length === 0) {
                historySection.innerHTML = '<p style="color: var(--fg-secondary); padding: 2rem;">No scans yet. Try a preset above!</p>';
                historySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            const stats = getStreakData();
            historySection.innerHTML = `
                <h3 style="margin-bottom: 1.5rem; color: var(--fg-primary);">Your Dashboard</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalScans}</div>
                        <div class="stat-label">Total Scans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.avgScore}</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.streak} <span class="streak-fire">${stats.streak > 0 ? '&#x1F525;' : ''}</span></div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.highestScore}</div>
                        <div class="stat-label">Highest Score</div>
                    </div>
                </div>
                <h4 style="margin-bottom: 1rem; color: var(--fg-secondary); font-size: 0.9rem;">Recent Scans</h4>
                <div class="history-timeline">
                    ${history.map((item, i) => `
                    <div class="history-item" onclick="reloadAnalysis('${i}')">
                        <div class="history-preview">
                            <div class="history-text">${item.text}...</div>
                            <div class="history-time">${item.timestamp}</div>
                        </div>
                        <div class="history-score" style="background: ${item.score > 70 ? 'rgba(255,107,122,0.2)' : item.score > 40 ? 'rgba(255,165,2,0.2)' : 'rgba(46,213,115,0.2)'}; color: ${item.score > 70 ? '#ff6b7a' : item.score > 40 ? '#ffb23a' : '#6edd89'};">
                            ${item.score}
                        </div>
                    </div>
                    `).join('')}
                </div>
            `;
            historySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function reloadAnalysis(index) {
            const history = JSON.parse(localStorage.getItem('filterHistory') || '[]');
            const item = history[index];
            document.getElementById('messageInput').value = item.fullText;
            analyzeMessage();
        }

        function updateLevel() {
            let count = parseInt(localStorage.getItem('scansCount') || '0') + 1;
            localStorage.setItem('scansCount', count);

            let level = 1, name = 'Novice';
            if (count > 30) { level = 4; name = 'Master Filter'; }
            else if (count > 15) { level = 3; name = 'Decoder'; }
            else if (count > 5) { level = 2; name = 'Aware'; }

            document.getElementById('levelNumber').textContent = level;
            document.getElementById('levelName').textContent = name;
            localStorage.setItem('userLevel', JSON.stringify({ level, name }));
        }

        function loadLevel() {
            const levelData = JSON.parse(localStorage.getItem('userLevel') || '{"level":1,"name":"Novice"}');
            document.getElementById('levelNumber').textContent = levelData.level;
            document.getElementById('levelName').textContent = levelData.name;
        }

        function submitFeedback(e) {
            e.preventDefault();

            const rating = document.querySelector('.star-btn.active')?.dataset.rating || 0;
            const comment = document.getElementById('feedbackComment').value;

            if (rating === 0) {
                showToast('Please select a rating');
                return;
            }

            let feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            feedback.push({ rating, comment, timestamp: new Date().toLocaleString() });
            localStorage.setItem('feedback', JSON.stringify(feedback));

            document.getElementById('feedbackForm').reset();
            document.querySelectorAll('.star-btn').forEach(btn => btn.classList.remove('active'));
            showToast('Thank you for your feedback!');
        }

        // === FEATURE 6: MIRROR MODE ===
        let mirrorMode = false;
        function toggleMirrorMode() {
            mirrorMode = !mirrorMode;
            document.getElementById('mirrorToggle').classList.toggle('active', mirrorMode);
            const textarea = document.getElementById('messageInput');
            textarea.placeholder = mirrorMode
                ? "Paste YOUR OWN message to see how it might come across. We flag any unintentional manipulation and help you communicate more authentically."
                : "Paste a message, email, DM, post, or any text you want to analyze. We'll decode what they really mean.";
            document.getElementById('analyzeBtn').innerHTML = mirrorMode
                ? '<span>&#129694;</span> Check My Message'
                : '<span>&#128269;</span> Analyze';
            // Clear previous results when switching modes
            document.getElementById('resultsContainer').classList.remove('show');
            if (mirrorMode) showToast('Mirror Mode ON - analyzing YOUR writing');
            else showToast('Defense Mode - analyzing incoming messages');
        }
        function getMirrorLabels() {
            return mirrorMode
                ? { said: 'You wrote:', meant: 'How this might land:', flagTitle: 'Patterns in YOUR writing', coachTitle: 'How to say it better' }
                : { said: 'They said:', meant: 'What this really means:', flagTitle: 'Psychological Profile', coachTitle: 'Your strategic response' };
        }
        function generateMirrorDecode(item) {
            // In mirror mode, reframe the decode as self-awareness advice
            const reframes = {
                'scarcity': 'You used artificial urgency. The recipient may feel pressured rather than motivated.',
                'deadline': 'Your deadline language creates pressure. Consider giving the reader genuine time to decide.',
                'fear': 'Fear-based language can damage trust. Try framing what they gain instead of what they lose.',
                'guilt': 'Guilt appeals erode relationships over time. Express your needs directly instead.',
                'love_bomb': 'Intense emotional language early on can feel overwhelming. Let feelings develop naturally.',
                'flattery_excessive': 'Over-the-top compliments can feel insincere. Be specific about what you genuinely appreciate.',
                'gaslighting': 'Dismissing someone\'s experience is harmful. Acknowledge their perspective even if you disagree.',
                'implicit_threat': 'Veiled threats damage trust. State consequences transparently or express your concerns directly.',
                'passive_aggression': 'Passive-aggressive language creates confusion. Say what you actually mean and feel.',
                'boundary_violation': 'This language pressures someone past their limits. Respect their capacity and ask, don\'t demand.',
                'commitment': 'Demanding commitment can feel coercive. Let people decide on their own terms.',
                'toxic_positivity': 'Dismissing negative emotions invalidates the other person. Acknowledge their struggle first.',
                'weaponized_therapy': 'Using therapy language as a weapon undermines genuine mental health work.',
            };
            // Try to match by checking if any key appears in the decoded text
            for (const [key, reframe] of Object.entries(reframes)) {
                if (item.decoded && item.decoded.toLowerCase().includes(key.replace('_',' '))) return reframe;
            }
            return 'This phrasing may come across differently than you intend. Consider how the reader might feel.';
        }

        // === FEATURE 7: REAL-TIME TYPING PREVIEW ===
        let realtimeTimeout = null;
        function updateRealtimePreview() {
            clearTimeout(realtimeTimeout);
            realtimeTimeout = setTimeout(() => {
                const text = document.getElementById('messageInput').value;
                const bar = document.getElementById('realtimeBarFill');
                const hint = document.getElementById('realtimeHint');
                if (!text || text.length < 15) {
                    bar.style.width = '0%';
                    hint.textContent = '';
                    return;
                }
                // Quick pattern scan (lightweight &mdash; not full analysis)
                let quickHits = 0;
                const quickPatterns = [
                    /\b(urgent|immediately|act now|limited time|expires|deadline|hurry|last chance|before (it's|it is) gone|closing soon|(don't|do not) wait)\b/i,
                    /\b(guarantee|risk.?free|double your|100%|no risk|sure thing|(can't|cannot) lose|guaranteed returns)\b/i,
                    /\b(everyone|nobody|always|never|all my friends|most people|nobody else|any reasonable person)\b/i,
                    /\b(trust me|believe me|honestly|frankly|(I'm|I am) just saying|between you and me|to be honest|let me be real)\b/i,
                    /\b(only you|special|exclusive|selected|different|unique|(you're|you are) not like|unlike anyone|one of a kind)\b/i,
                    /\b((don't|do not) tell|secret|confidential|between us|off the record|insider|classified|privileged)\b/i,
                    /\b(if you don't|(you'll|you will) regret|miss out|lose|too late|consequences|risk everything|last warning|your fault)\b/i,
                    /\b(after everything I've done|ungrateful|selfish|you owe|I sacrificed|gave up everything|disappointed in you|how could you)\b/i,
                    /\b((you're|you are) (so|really|truly|incredibly) (smart|talented|amazing|brilliant|beautiful|special)|I've never (met|felt|seen)|no one (compares|is like you))\b/i,
                    /\b(I never said that|(you're|you are) (overreacting|imagining|too sensitive|being dramatic|crazy)|that (didn't|did not) happen|calm down|it was just a joke)\b/i,
                    /\b((you're|you are) (with us|against)|take it or leave|now or never|either|or else|my way or|because I said so)\b/i,
                    /\b(I need you to|drop everything|cancel your|not (taking|accepting) no|this (isn't|is not) (optional|negotiable)|figure it out)\b/i,
                ];
                quickPatterns.forEach(p => { if (p.test(text)) quickHits++; });
                const pct = Math.min(100, Math.round((quickHits / quickPatterns.length) * 100));
                bar.style.width = pct + '%';
                bar.style.background = pct > 60 ? '#ff6b7a' : pct > 30 ? '#ffb23a' : 'var(--success)';
                if (quickHits === 0) hint.textContent = text.length > 50 ? 'No obvious flags yet - hit Analyze for deep scan' : 'Type more for preview...';
                else if (quickHits <= 2) hint.textContent = `${quickHits} potential flag${quickHits > 1 ? 's' : ''} &mdash; hit Analyze for details`;
                else hint.textContent = `&#x26A0;&#xFE0F; ${quickHits} red flags detected &mdash; analyze this message`;
                hint.style.color = pct > 60 ? '#ff6b7a' : pct > 30 ? '#ffb23a' : 'var(--fg-secondary)';
            }, 300);
        }

        // === FEATURE 8: DARK/LIGHT THEME TOGGLE ===
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            document.getElementById('themeToggle').textContent = isLight ? '&#x2600;&#xFE0F;' : '&#x1F319;';
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').textContent = '&#x2600;&#xFE0F;';
            }
        }

        // === FEATURE 9: SCAN HISTORY DASHBOARD ===
        function getStreakData() {
            const history = JSON.parse(localStorage.getItem('filterHistory') || '[]');
            const totalScans = history.length;
            const avgScore = totalScans ? Math.round(history.reduce((s, h) => s + h.score, 0) / totalScans) : 0;
            // Streak: consecutive days with scans
            const today = new Date().toDateString();
            let streak = 0;
            const daySet = new Set(history.map(h => new Date(h.timestamp).toDateString()));
            const d = new Date();
            while (daySet.has(d.toDateString())) {
                streak++;
                d.setDate(d.getDate() - 1);
            }
            const highestScore = totalScans ? Math.max(...history.map(h => h.score)) : 0;
            return { totalScans, avgScore, streak, highestScore };
        }

        // Override showHistory to include dashboard
        const _origShowHistory = typeof showHistory === 'function' ? showHistory : null;

        // === FEATURE 10: SOUND DESIGN + HAPTICS ===
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        function ensureAudio() { if (!audioCtx) audioCtx = new AudioCtx(); return audioCtx; }

        function playTone(freq, duration, type='sine', vol=0.08) {
            try {
                const ctx = ensureAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(gain).connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            } catch(e) {}
        }

        function playScanSound() {
            // Quick ascending arpeggio
            playTone(400, 0.15, 'sine', 0.06);
            setTimeout(() => playTone(600, 0.15, 'sine', 0.06), 100);
            setTimeout(() => playTone(800, 0.2, 'sine', 0.06), 200);
        }

        function playResultSound(score) {
            if (score > 70) {
                // Danger: descending tones
                playTone(600, 0.2, 'square', 0.04);
                setTimeout(() => playTone(400, 0.3, 'square', 0.04), 150);
                // Haptic
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            } else if (score > 40) {
                // Warning: two-tone
                playTone(500, 0.2, 'triangle', 0.05);
                setTimeout(() => playTone(450, 0.25, 'triangle', 0.05), 200);
                if (navigator.vibrate) navigator.vibrate(80);
            } else {
                // Safe: pleasant ding
                playTone(800, 0.3, 'sine', 0.06);
                setTimeout(() => playTone(1000, 0.4, 'sine', 0.05), 150);
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function nextOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            let currentIndex = Array.from(steps).findIndex(s => s.classList.contains('active'));
            if (currentIndex < steps.length - 1) {
                steps[currentIndex].classList.remove('active');
                steps[currentIndex + 1].classList.add('active');
            }
        }

        function skipOnboarding() {
            document.getElementById('onboardingOverlay').classList.remove('show');
            // Now start the guided tour after onboarding is dismissed
            startOnboardingTour();
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initializeUI);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        function showInstallBanner() {
            const banner = document.createElement('div');
            banner.id = 'installBanner';
            banner.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--accent-purple),var(--accent-cyan));padding:12px 24px;border-radius:16px;display:flex;align-items:center;gap:12px;z-index:10000;box-shadow:0 8px 32px rgba(139,92,246,0.4);cursor:pointer;max-width:calc(100vw - 40px);box-sizing:border-box;';
            banner.innerHTML = '<span style="font-size:1.5rem;">&#x1F4F1;</span><span style="color:#fff;font-weight:600;">Add to Home Screen</span><span style="color:rgba(255,255,255,0.7);font-size:0.85rem;">No app store needed</span>';
            banner.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
                banner.remove();
            };
            document.body.appendChild(banner);
            setTimeout(() => { if (banner.parentNode) banner.remove(); }, 15000);
        }
    </script>
    <script>
    // Embed mode: hide header/footer when loaded in iframe
    (function() {
        if (new URLSearchParams(window.location.search).has('embed')) {
            var h = document.querySelector('header');
            var f = document.querySelector('footer');
            if (h) h.style.display = 'none';
            if (f) f.style.display = 'none';
            document.body.style.paddingTop = '0';
            document.body.style.background = 'transparent';
        }
    })();
    </script>
</body>
</html>
